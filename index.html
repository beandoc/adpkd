<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADPKD Risk Assessment & Road Map</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* --- Modern CSS Reset --- */
        *, *::before, *::after { box-sizing: border-box; }
        body, h1, h2, h3, p, ul, li { margin: 0; }
        ul { padding: 0; list-style: none; }
        button, input, select { font: inherit; }

        /* --- CSS Variables for a Professional Theme --- */
        :root {
            --blue-primary: #3b82f6;
            --blue-dark: #2563eb;
            --grey-background: #f3f4f6;
            --card-background: #ffffff;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;

            /* eGFR Slider Colors */
            --egfr-green: #28a745; /* Stage 1-2 */
            --egfr-yellow: #ffc107; /* Stage 3a-3b */
            --egfr-orange: #fd7e14; /* Stage 4 */
            --egfr-red: #dc3545; /* Stage 5 */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background-color: var(--grey-background);
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            max-width: 1200px;
            width: 100%;
        }

        @media (min-width: 768px) {
            .container {
                grid-template-columns: 2fr 1fr;
            }
        }

        header {
            grid-column: 1 / -1;
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            color: var(--blue-dark);
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .card {
            background-color: var(--card-background);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .card h2 {
            color: var(--blue-primary);
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.75rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--text-dark);
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 1rem;
            color: var(--text-dark);
        }

        .form-group input[type="radio"] {
            margin-right: 0.5rem;
        }

        .radio-group label {
            display: inline-block;
            margin-right: 1.5rem;
            font-weight: normal;
        }

        button {
            display: inline-block;
            background-color: var(--blue-primary);
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            margin-top: 1rem;
        }

        button:hover {
            background-color: var(--blue-dark);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .result-item {
            background-color: var(--grey-background);
            padding: 1rem;
            border-radius: var(--radius-md);
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .result-item span {
            display: block;
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 0.2rem;
        }

        .ckd-stage-1 { background-color: #d4edda; color: #155724; } /* Green */
        .ckd-stage-2 { background-color: #d4edda; color: #155724; } /* Green */
        .ckd-stage-3a { background-color: #fff3cd; color: #856404; } /* Yellow */
        .ckd-stage-3b { background-color: #fff3cd; color: #856404; } /* Yellow */
        .ckd-stage-4 { background-color: #ffeeba; color: #856404; } /* Orange-ish Yellow */
        .ckd-stage-5 { background-color: #f8d7da; color: #721c24; } /* Red */

        .recommendations-list {
            list-style: none;
            padding: 0;
            margin-top: 1.5rem;
        }

        .recommendations-list li {
            background-color: var(--grey-background);
            padding: 0.8rem 1.2rem;
            margin-bottom: 0.5rem;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            font-size: 0.95rem;
        }

        .recommendations-list li strong {
            color: var(--blue-dark);
            margin-right: 0.5rem;
            font-weight: bold;
        }

        .previous-creatinine-entry {
            display: grid;
            grid-template-columns: 1fr 1fr 0.1fr; /* Date, Creatinine, Delete Button */
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 10px;
        }

        .previous-creatinine-entry input {
            width: 100%;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 0.6em 0.8em;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.9rem;
            align-self: center;
            margin-top: 0; /* Override default button margin */
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

        #addPreviousCreatinine {
            margin-top: 10px;
            padding: 0.6rem 1rem;
            font-size: 0.95rem;
        }

        /* Chart Styling */
        .chart-container {
            position: relative;
            height: 300px; /* Fixed height for chart */
            width: 100%;
            margin-top: 1.5rem;
            background-color: var(--card-background);
            padding: 1rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow);
        }

        /* Slider Styling */
        .egfr-slider-container {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: var(--grey-background);
            border-radius: var(--radius-md);
        }

        .egfr-slider-container h3 {
            color: var(--blue-primary);
            font-size: 1.4rem;
            margin-bottom: 1rem;
        }

        .egfr-slider {
            width: 100%;
            -webkit-appearance: none;
            height: 20px;
            background: linear-gradient(to right,
                var(--egfr-green) 0%,
                var(--egfr-green) 50%,   /* eGFR 60-90 (Stage 1-2) */
                var(--egfr-yellow) 50%,
                var(--egfr-yellow) 70%,  /* eGFR 45-59 (Stage 3a) */
                var(--egfr-orange) 70%,
                var(--egfr-orange) 85%,  /* eGFR 30-44 (Stage 3b-4) */
                var(--egfr-red) 85%,
                var(--egfr-red) 100%     /* eGFR < 15 (Stage 5) */
            );
            border-radius: 10px;
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
            margin-top: 1rem;
        }

        .egfr-slider:hover {
            opacity: 1;
        }

        .egfr-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--blue-dark);
            cursor: pointer;
            border: 3px solid var(--card-background);
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }

        .egfr-slider::-moz-range-thumb {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--blue-dark);
            cursor: pointer;
            border: 3px solid var(--card-background);
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }

        .slider-values {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .slider-current-value {
            font-weight: bold;
            color: var(--blue-dark);
            font-size: 1.1rem;
            margin-top: 0.8rem;
            text-align: center;
        }
        .risk-level-tag {
            display: inline-block;
            padding: 0.3em 0.8em;
            border-radius: 0.5em;
            font-weight: bold;
            font-size: 0.85em;
            margin-top: 0.5em;
        }

        .risk-level-tag.low { background-color: #d4edda; color: #155724; }
        .risk-level-tag.intermediate { background-color: #fff3cd; color: #856404; }
        .risk-level-tag.high { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ADPKD Risk Assessment & Road Map</h1>
            <p>Calculate your eGFR, assess ADPKD progression risk, and get personalized recommendations.</p>
        </header>

        <div class="card">
            <h2>Patient Information</h2>
            <div class="form-group">
                <label for="patientName">Patient Name</label>
                <input type="text" id="patientName" placeholder="Enter patient's name">
            </div>
            <div class="form-group">
                <label for="age">Age</label>
                <input type="number" id="age" min="18" max="100" placeholder="Enter age" required>
            </div>
            <div class="form-group">
                <label>Sex</label>
                <div class="radio-group">
                    <label><input type="radio" name="sex" value="male" id="sexMale" required> Male</label>
                    <label><input type="radio" name="sex" value="female" id="sexFemale"> Female</label>
                </div>
            </div>
            <div class="form-group">
                <label>Ethnicity</label>
                <div class="radio-group">
                    <label><input type="radio" name="ethnicity" value="non-african" id="ethnicityNonAfrican" required> Non-African American</label>
                    <label><input type="radio" name="ethnicity" value="african" id="ethnicityAfrican"> African American</label>
                </div>
            </div>
            <div class="form-group">
                <label for="currentCreatinine">Current Serum Creatinine (mg/dL)</label>
                <input type="number" id="currentCreatinine" step="0.01" min="0.1" placeholder="e.g., 1.0" required>
            </div>
            <div class="form-group">
                <label for="currentCreatinineDate">Date of Current Creatinine Measurement</label>
                <input type="date" id="currentCreatinineDate" required>
            </div>

            <div class="form-group">
                <h3>Previous Creatinine Measurements</h3>
                <div id="previousCreatinineEntries">
                    </div>
                <button type="button" id="addPreviousCreatinine">Add Previous Measurement</button>
            </div>

            <div class="form-group">
                <label for="height">Height (cm)</label>
                <input type="number" id="height" step="0.1" min="50" placeholder="e.g., 170" required>
            </div>
            <div class="form-group">
                <label for="weight">Weight (kg)</label>
                <input type="number" id="weight" step="0.1" min="10" placeholder="e.g., 70" required>
            </div>

            <div class="form-group">
                <label>History of Hypertension?</label>
                <div class="radio-group">
                    <label><input type="radio" name="hypertension" value="yes" required> Yes</label>
                    <label><input type="radio" name="hypertension" value="no"> No</label>
                </div>
            </div>
            <div class="form-group">
                <label>Previous cardiovascular event (e.g., stroke, MI)?</label>
                <div class="radio-group">
                    <label><input type="radio" name="cardiovascularEvent" value="yes" required> Yes</label>
                    <label><input type="radio" name="cardiovascularEvent" value="no"> No</label>
                </div>
            </div>
            <div class="form-group">
                <label>Known PKD1 gene mutation?</label>
                <div class="radio-group">
                    <label><input type="radio" name="pkd1Mutation" value="yes" required> Yes</label>
                    <label><input type="radio" name="pkd1Mutation" value="no"> No</label>
                    <label><input type="radio" name="pkd1Mutation" value="unknown"> Unknown</label>
                </div>
            </div>

            <button type="submit" onclick="calculateAndDisplay()">Calculate eGFR & Risk</button>
        </div>

        <div class="card" id="resultsCard" style="display: none;">
            <h2>Your eGFR Results</h2>
            <p id="patientNameDisplay" style="font-weight: bold; font-size: 1.2rem; margin-bottom: 1rem;"></p>
            <div class="results-grid">
                <div class="result-item ckd-stage-1">
                    <span id="egfrResult">--</span>
                    <span>eGFR (mL/min/1.73m²)</span>
                </div>
                <div class="result-item ckd-stage-1">
                    <span id="ckdStageResult">--</span>
                    <span>CKD Stage</span>
                </div>
                <div class="result-item ckd-stage-1">
                    <span id="annualDeclineResult">--</span>
                    <span>Annual eGFR Decline</span>
                </div>
            </div>

            <div class="chart-container">
                <h3>eGFR Trend Over Time</h3>
                <canvas id="egfrTrendChart"></canvas>
            </div>

            <div class="egfr-slider-container">
                <h3>Explore Future Scenarios</h3>
                <input type="range" min="5" max="120" value="60" class="egfr-slider" id="egfrProjectionSlider" oninput="updateProjectedEgfrAndRecommendations()">
                <div class="slider-values">
                    <span>5</span>
                    <span>30</span>
                    <span>60</span>
                    <span>90</span>
                    <span>120</span>
                </div>
                <div class="slider-current-value">
                    Projected eGFR: <span id="projectedEgfrDisplay">60</span> mL/min/1.73m²
                    <br>
                    CKD Stage: <span id="projectedCkdStageDisplay">3a</span>
                </div>
            </div>

            <h2>ADPKD Progression Risk</h2>
            <div class="results-grid">
                <div class="result-item">
                    <span id="propkdScoreResult">--</span>
                    <span>PROPKD Score</span>
                </div>
                <div class="result-item">
                    <span id="propkdRiskProfileResult">--</span>
                    <span id="propkdRiskLevelTag" class="risk-level-tag">--</span>
                </div>
            </div>

            <h2>Personalized Recommendations</h2>
            <ul id="recommendationsList" class="recommendations-list">
                </ul>
        </div>
    </div>

    <script>
        let egfrTrendChartInstance = null;
        let previousCreatinineData = []; // Stores { date: DateObject, creatinine: value }

        // Helper function to format date for input type="date"
        function formatDateForInput(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Set default dates on load
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            document.getElementById('currentCreatinineDate').value = formatDateForInput(today);

            // Add an initial previous measurement field with a default date of one year ago
            addPreviousCreatinineEntry(true); // true to indicate initial load, prevents immediate deletion
        });

        // Function to add a new previous creatinine entry field
        document.getElementById('addPreviousCreatinine').addEventListener('click', () => addPreviousCreatinineEntry(false));

        function addPreviousCreatinineEntry(isInitial = false) {
            const container = document.getElementById('previousCreatinineEntries');
            const entryDiv = document.createElement('div');
            entryDiv.classList.add('previous-creatinine-entry');

            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.placeholder = 'Date (YYYY-MM-DD)';
            dateInput.required = true;

            const creatinineInput = document.createElement('input');
            creatinineInput.type = 'number';
            creatinineInput.step = '0.01';
            creatinineInput.min = '0.1';
            creatinineInput.placeholder = 'Creatinine (mg/dL)';
            creatinineInput.required = true;

            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.classList.add('delete-btn');
            deleteBtn.textContent = 'X';
            deleteBtn.onclick = function() {
                entryDiv.remove();
            };

            entryDiv.appendChild(dateInput);
            entryDiv.appendChild(creatinineInput);
            entryDiv.appendChild(deleteBtn);

            container.appendChild(entryDiv);

            // Set default date for new entries to one year ago
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            dateInput.value = formatDateForInput(oneYearAgo);

            // Hide delete button for the initial field, if there's only one
            if (isInitial && container.children.length === 1) {
                deleteBtn.style.display = 'none';
            } else {
                deleteBtn.style.display = 'inline-block';
            }
        }


        function calculateAndDisplay() {
            const patientName = document.getElementById('patientName').value;
            const age = parseFloat(document.getElementById('age').value);
            const sex = document.querySelector('input[name="sex"]:checked').value;
            const ethnicity = document.querySelector('input[name="ethnicity"]:checked').value;
            const currentCreatinine = parseFloat(document.getElementById('currentCreatinine').value);
            const currentCreatinineDateStr = document.getElementById('currentCreatinineDate').value;
            const currentCreatinineDate = new Date(currentCreatinineDateStr);

            const height = parseFloat(document.getElementById('height').value);
            const weight = parseFloat(document.getElementById('weight').value);
            const hypertension = document.querySelector('input[name="hypertension"]:checked').value;
            const cardiovascularEvent = document.querySelector('input[name="cardiovascularEvent"]:checked').value;
            const pkd1Mutation = document.querySelector('input[name="pkd1Mutation"]:checked').value;

            document.getElementById('patientNameDisplay').textContent = `Patient: ${patientName}`;

            // Calculate eGFR (CKD-EPI equation)
            let kappa, alpha, minCreatinine, maxCreatinine;
            if (sex === 'female') {
                kappa = 0.7;
                alpha = -0.329;
            } else {
                kappa = 0.9;
                alpha = -0.411;
            }

            minCreatinine = currentCreatinine / kappa;
            maxCreatinine = currentCreatinine / kappa;

            let egfr = 141 *
                       Math.pow(Math.min(minCreatinine, 1), alpha) *
                       Math.pow(Math.max(maxCreatinine, 1), -1.209) *
                       Math.pow(0.993, age);

            if (sex === 'female') {
                egfr *= 1.018;
            }
            if (ethnicity === 'african') {
                egfr *= 1.159;
            }

            egfr = Math.round(egfr);

            let ckdStage = '';
            let ckdStageClass = '';
            if (egfr >= 90) { ckdStage = '1'; ckdStageClass = 'ckd-stage-1'; }
            else if (egfr >= 60) { ckdStage = '2'; ckdStageClass = 'ckd-stage-2'; }
            else if (egfr >= 45) { ckdStage = '3a'; ckdStageClass = 'ckd-stage-3a'; }
            else if (egfr >= 30) { ckdStage = '3b'; ckdStageClass = 'ckd-stage-3b'; }
            else if (egfr >= 15) { ckdStage = '4'; ckdStageClass = 'ckd-stage-4'; }
            else { ckdStage = '5'; ckdStageClass = 'ckd-stage-5'; }

            document.getElementById('egfrResult').textContent = egfr;
            document.getElementById('egfrResult').parentElement.className = `result-item ${ckdStageClass}`;
            document.getElementById('ckdStageResult').textContent = ckdStage;
            document.getElementById('ckdStageResult').parentElement.className = `result-item ${ckdStageClass}`;

            // Collect all creatinine data points for trend analysis
            previousCreatinineData = []; // Clear previous data
            previousCreatinineData.push({ date: currentCreatinineDate, creatinine: currentCreatinine, egfr: egfr });

            const previousEntries = document.querySelectorAll('#previousCreatinineEntries .previous-creatinine-entry');
            previousEntries.forEach(entryDiv => {
                const dateStr = entryDiv.querySelector('input[type="date"]').value;
                const creat = parseFloat(entryDiv.querySelector('input[type="number"]').value);
                if (dateStr && !isNaN(creat)) {
                    const date = new Date(dateStr);
                     // Recalculate eGFR for previous entries for the chart
                    let prevEgfr = 141 *
                               Math.pow(Math.min(creat / kappa, 1), alpha) *
                               Math.pow(Math.max(creat / kappa, 1), -1.209) *
                               Math.pow(0.993, age); // Using current age for simplicity, a more advanced model would adjust for age at time of measurement

                    if (sex === 'female') {
                        prevEgfr *= 1.018;
                    }
                    if (ethnicity === 'african') {
                        prevEgfr *= 1.159;
                    }
                    previousCreatinineData.push({ date: date, creatinine: creat, egfr: Math.round(prevEgfr) });
                }
            });

            // Sort points by date ascending for the graph
            previousCreatinineData.sort((a, b) => a.date - b.date);

            // Calculate Annual eGFR Decline
            let annualDecline = '--';
            if (previousCreatinineData.length >= 2) {
                const latest = previousCreatinineData[previousCreatinineData.length - 1];
                const earliest = previousCreatinineData[0];

                const timeDiffDays = (latest.date - earliest.date) / (1000 * 60 * 60 * 24);
                if (timeDiffDays > 0) {
                    const egfrDiff = earliest.egfr - latest.egfr;
                    annualDecline = (egfrDiff / (timeDiffDays / 365.25)).toFixed(1);
                }
            }
            const declineResultEl = document.getElementById('annualDeclineResult');
            declineResultEl.textContent = `${annualDecline} mL/min/1.73m²/year`;
            declineResultEl.parentElement.className = `result-item ${ckdStageClass}`;


            renderEgfrTrendChart(previousCreatinineData);


            // PROPKD Score
            let scores = { male: 0, htn: 0, event: 0, mutation: 0 };
            if (sex === 'male') scores.male = 1;
            if (hypertension === 'yes') scores.htn = 2;
            if (cardiovascularEvent === 'yes') scores.event = 2;
            if (pkd1Mutation === 'yes') scores.mutation = 2;

            const score = scores.male + scores.htn + scores.event + scores.mutation;

            document.getElementById('propkd_male').children[1].textContent = `${scores.male} points`;
            document.getElementById('propkd_htn').children[1].textContent = `${scores.htn} points`;
            document.getElementById('propkd_event').children[1].textContent = `${scores.event} points`;
            document.getElementById('propkd_mutation').children[1].textContent = `${scores.mutation} points`;
            document.getElementById('propkdScoreResult').textContent = score;

            let riskProfile = '', riskClass = '';
            if (score <= 3) { riskProfile = 'Low Risk (Median age for ESRD: ~70.6 years)'; riskClass = 'low'; }
            else if (score <= 6) { riskProfile = 'Intermediate Risk (Median age for ESRD: ~56.9 years)'; riskClass = 'intermediate'; }
            else { riskProfile = 'High Risk (Median age for ESRD: ~49 years)'; riskClass = 'high'; }

            const tagEl = document.getElementById('propkdRiskLevelTag');
            tagEl.textContent = riskClass.charAt(0).toUpperCase() + riskClass.slice(1) + " Risk";
            tagEl.className = `risk-level-tag ${riskClass}`;

            let profileText = riskProfile;
            if (pkd1Mutation === 'unknown') profileText += ' *Provisional assessment as mutation type is unknown.*';
            document.getElementById('propkdRiskProfileResult').textContent = profileText;


            generateAndDisplayRecommendations(egfr, ckdStage, sex);
            document.getElementById('resultsCard').style.display = 'block';

            // Initialize slider to current eGFR
            const egfrProjectionSlider = document.getElementById('egfrProjectionSlider');
            egfrProjectionSlider.value = egfr;
            updateProjectedEgfrAndRecommendations();
        }

        const ALL_RECOMMENDATIONS = [
            { category: 'Diet', minEgfr: 60, maxEgfr: 120, text: 'Maintain a balanced diet, limit sodium intake to <2g/day.' },
            { category: 'Diet', minEgfr: 30, maxEgfr: 59, text: 'Moderate protein restriction (0.8 g/kg/day), phosphorus control.' },
            { category: 'Diet', minEgfr: 0, maxEgfr: 29, text: 'Strict protein, potassium, and phosphorus restriction. Consult a renal dietitian.' },

            { category: 'Fluid Intake', minEgfr: 0, maxEgfr: 120, text: 'Stay well-hydrated. Aim for 2-3 liters of water daily, especially if on vasopressin receptor antagonists (e.g., Tolvaptan).' },

            { category: 'Blood Pressure', minEgfr: 0, maxEgfr: 120, text: 'Target blood pressure <110/75 mmHg. ACE inhibitors or ARBs are often preferred.' },

            { category: 'Pain Management', minEgfr: 0, maxEgfr: 120, text: 'Avoid NSAIDs (e.g., ibuprofen, naproxen). Use acetaminophen (paracetamol) for pain relief.' },

            { category: 'Monitoring', minEgfr: 0, maxEgfr: 120, text: 'Regular monitoring of blood pressure, eGFR, and urine albumin-to-creatinine ratio (UACR).' },
            { category: 'Monitoring', minEgfr: 60, maxEgfr: 120, text: 'Annual imaging (ultrasound or MRI) to monitor kidney size and cyst growth.' },
            { category: 'Monitoring', minEgfr: 0, maxEgfr: 59, text: 'More frequent eGFR monitoring (every 3-6 months) and electrolyte checks.' },

            { category: 'Medications', minEgfr: 30, maxEgfr: 120, text: 'Discuss Tolvaptan eligibility if eGFR >30 mL/min/1.73m² and rapid progression is evident.' },
            { category: 'Medications', minEgfr: 0, maxEgfr: 120, text: 'Avoid nephrotoxic drugs. Review all medications with your nephrologist.' },
            { category: 'Medications', minEgfr: 0, maxEgfr: 29, text: 'Iron supplements, erythropoiesis-stimulating agents (ESAs), and active Vitamin D may be needed.' },

            { category: 'Lifestyle', minEgfr: 0, maxEgfr: 120, text: 'Regular physical activity and maintaining a healthy weight.' },
            { category: 'Lifestyle', minEgfr: 0, maxEgfr: 120, text: 'Quit smoking and limit alcohol consumption.' },

            { category: 'Vaccinations', minEgfr: 0, maxEgfr: 120, text: 'Ensure up-to-date vaccinations, including influenza and pneumococcal vaccines.' },

            { category: 'Pregnancy', minEgfr: 0, maxEgfr: 120, text: 'Close monitoring of blood pressure and kidney function is crucial during pregnancy. High-risk pregnancy management advised.' }
        ];

        function generateAndDisplayRecommendations(egfr, ckdStage, sex) {
            const recommendationsList = document.getElementById('recommendationsList');
            recommendationsList.innerHTML = ''; // Clear previous recommendations

            const filteredRecommendations = ALL_RECOMMENDATIONS.filter(rec => {
                const withinEgfrRange = egfr >= rec.minEgfr && egfr <= rec.maxEgfr;
                const notPregnancyForMale = (rec.category !== 'Pregnancy' || sex === 'female');
                return withinEgfrRange && notPregnancyForMale;
            });

            const uniqueCategories = new Set();

            filteredRecommendations.forEach(rec => {
                // To avoid duplicate categories from showing up multiple times for different eGFR ranges if a broader recommendation exists.
                // This logic prioritizes showing recommendations relevant to the specific eGFR first, or general if specific not found.
                // For simplicity here, we will just list all relevant recommendations.
                // For more advanced logic, one might need to sort by eGFR range specificity or priority.

                const listItem = document.createElement('li');
                listItem.innerHTML = `<strong>${rec.category}:</strong> ${rec.text}`;
                recommendationsList.appendChild(listItem);
            });

            if (filteredRecommendations.length === 0) {
                const listItem = document.createElement('li');
                listItem.textContent = 'No specific recommendations found for the current eGFR range. Consult your doctor for personalized advice.';
                recommendationsList.appendChild(listItem);
            }
        }


        function renderEgfrTrendChart(dataPoints) {
            const ctx = document.getElementById('egfrTrendChart').getContext('2d');

            // Destroy existing chart if it exists
            if (egfrTrendChartInstance) {
                egfrTrendChartInstance.destroy();
            }

            const labels = dataPoints.map(point => point.date.toLocaleDateString());
            const egfrValues = dataPoints.map(point => point.egfr);

            // Determine max Y-axis value
            const maxEgfr = Math.max(...egfrValues, 100); // Ensure Y-axis goes at least to 100
            const suggestedMax = Math.ceil(maxEgfr / 10) * 10; // Round up to nearest 10 for clean axis

            egfrTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'eGFR (mL/min/1.73m²)',
                        data: egfrValues,
                        borderColor: varColors['blue-primary'],
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: varColors['blue-dark'],
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: varColors['blue-dark']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'category',
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'eGFR (mL/min/1.73m²)'
                            },
                            max: suggestedMax, // Dynamically set max value
                            ticks: {
                                stepSize: 10
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `eGFR: ${context.parsed.y} mL/min/1.73m²`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Access CSS variables in JS for Chart.js
        const style = getComputedStyle(document.body);
        const varColors = {
            'blue-primary': style.getPropertyValue('--blue-primary').trim(),
            'blue-dark': style.getPropertyValue('--blue-dark').trim(),
            'egfr-green': style.getPropertyValue('--egfr-green').trim(),
            'egfr-yellow': style.getPropertyValue('--egfr-yellow').trim(),
            'egfr-orange': style.getPropertyValue('--egfr-orange').trim(),
            'egfr-red': style.getPropertyValue('--egfr-red').trim(),
        };

        function updateProjectedEgfrAndRecommendations() {
            const slider = document.getElementById('egfrProjectionSlider');
            const projectedEgfr = parseFloat(slider.value);

            let projectedCkdStage = '';
            if (projectedEgfr >= 90) { projectedCkdStage = '1'; }
            else if (projectedEgfr >= 60) { projectedCkdStage = '2'; }
            else if (projectedEgfr >= 45) { projectedCkdStage = '3a'; }
            else if (projectedEgfr >= 30) { projectedCkdStage = '3b'; }
            else if (projectedEgfr >= 15) { projectedCkdStage = '4'; }
            else { projectedCkdStage = '5'; }

            document.getElementById('projectedEgfrDisplay').textContent = projectedEgfr;
            document.getElementById('projectedCkdStageDisplay').textContent = projectedCkdStage;

            // Get the selected sex from the input fields
            const sex = document.querySelector('input[name="sex"]:checked')?.value || 'male'; // Default to male if not selected

            generateAndDisplayRecommendations(projectedEgfr, projectedCkdStage, sex);
        }

    </script>
</body>
</html>
