<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADPKD Risk Assessment & Road Map</title>
    <style>
        /* --- Modern CSS Reset --- */
        *, *::before, *::after { box-sizing: border-box; }
        body, h1, h2, h3, p, ul, li { margin: 0; }
        ul { padding: 0; list-style: none; }
        button, input, select { font: inherit; }

        /* --- CSS Variables for a Professional Theme --- */
        :root {
            --blue-primary: #3b82f6;
            --blue-dark: #2563eb;
            --grey-background: #f3f4f6;
            --card-background: #ffffff;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            
            /* Category & Semantic Colors */
            --green: #10b981; --green-bg: #f0fdf4; /* Lifestyle */
            --teal: #14b8a6; --teal-bg: #f0fdfa; /* Medical */
            --yellow: #f59e0b; --yellow-bg: #fffbeb; /* Monitoring */
            --pink: #ec4899; --pink-bg: #fdf2f8; /* Pregnancy */
            --orange: #f97316; --orange-bg: #fff7ed; /* Complications */
            --indigo: #6366f1; --indigo-bg: #eef2ff; /* Neurological */
            --red: #ef4444; --red-bg: #fef2f2; /* Future/High Risk */
        }

        /* --- General Body & Layout --- */
        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--grey-background);
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .hero-header {
            background-color: var(--blue-primary);
            color: white;
            padding: 2.5rem 1rem;
            text-align: center;
        }
        .hero-header h1 { font-size: 2.25rem; font-weight: 700; }
        .hero-header p { font-size: 1.125rem; opacity: 0.9; margin-top: 0.5rem; }

        .main-container {
            max-width: 950px;
            margin: -2rem auto 2rem auto;
            padding: 0 1rem;
            position: relative;
            z-index: 10;
        }
        
        .card {
            background-color: var(--card-background);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 1.5rem 2rem;
            margin-bottom: 1.5rem;
        }
        .card h2 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; }

        /* --- Form Styling --- */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        .input-group label, .radio-group-label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-dark); }
        .input-group input, .input-group select {
            width: 100%;
            padding: 0.65rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: var(--blue-primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        
        .radio-group { display: flex; gap: 1rem; }
        .radio-group label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .radio-group input[type="radio"] {
            -webkit-appearance: none;
            appearance: none;
            width: 1.25em; height: 1.25em;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            transition: 0.2s all linear;
        }
        .radio-group input[type="radio"]:checked { border: 5px solid var(--blue-primary); }

        .action-button {
            background-color: var(--blue-primary);
            color: white;
            font-weight: 600; padding: 0.75rem 1.5rem;
            border: none; border-radius: var(--radius-md);
            cursor: pointer; transition: background-color 0.2s;
        }
        .action-button:hover { background-color: var(--blue-dark); }
        .secondary-button { background-color: transparent; color: var(--blue-primary); font-weight: 600; cursor:pointer; border:none; padding: 0.5rem; }
        
        /* --- Previous Creatinine Entries --- */
        #previousCreatinineList .entry { display: grid; grid-template-columns: repeat(3, 1fr) auto; gap: 1rem; align-items: end; padding: 1rem 0; border-bottom: 1px solid var(--border-color); }
        #previousCreatinineList .entry:first-child { border-top: 1px solid var(--border-color); }
        .delete-btn { background: var(--red-bg); color: var(--red); border:none; border-radius:var(--radius-md); width: 44px; height: 44px; cursor:pointer; font-size: 1.2rem; }

        /* --- Results Section --- */
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: center; }
        .egfr-display h3 { color: var(--text-light); font-weight: 500; }
        .egfr-display .value { font-size: 2.5rem; font-weight: 700; color: var(--blue-primary); }
        .ckd-stages-container { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .ckd-stage-pill { padding: 0.3rem 0.8rem; border-radius: 99px; font-weight: 500; border: 1px solid var(--border-color); }
        .ckd-stage-pill.g1 { background-color: var(--green-bg); border-color: var(--green); color: var(--green); }
        .ckd-stage-pill.g2 { background-color: var(--green-bg); border-color: var(--green); color: var(--green); }
        .ckd-stage-pill.g3a { background-color: var(--yellow-bg); border-color: var(--yellow); color: var(--yellow); }
        .ckd-stage-pill.g3b { background-color: var(--yellow-bg); border-color: var(--yellow); color: var(--yellow); }
        .ckd-stage-pill.g4 { background-color: var(--red-bg); border-color: var(--red); color: var(--red); }
        .ckd-stage-pill.g5 { background-color: var(--red-bg); border-color: var(--red); color: var(--red); }
        .ckd-stage-pill.active { transform: scale(1.1); box-shadow: 0 0 10px rgba(0,0,0,0.1);}
        
        /* --- PROPKD Score Section --- */
        .propkd-results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1.5rem; }
        .propkd-breakdown div { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed var(--border-color); }
        .propkd-breakdown span:last-child { font-weight: 600; }
        .propkd-breakdown .total { font-weight: 700; color: var(--blue-primary); font-size: 1.2rem; }
        .propkd-risk-profile { background-color: var(--grey-background); padding: 1rem; border-radius: var(--radius-md); }
        .propkd-risk-profile .risk-level-tag { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 99px; font-weight: 600; margin-bottom: 0.5rem; }
        .propkd-risk-profile .risk-level-tag.low { background-color: var(--green-bg); color: var(--green); }
        .propkd-risk-profile .risk-level-tag.intermediate { background-color: var(--yellow-bg); color: var(--yellow); }
        .propkd-risk-profile .risk-level-tag.high { background-color: var(--red-bg); color: var(--red); }

        /* --- Recommendations Section --- */
        .filter-buttons { display: flex; flex-wrap:wrap; gap: 0.5rem; margin-bottom: 1.5rem; }
        .filter-button { background-color: var(--grey-background); color: var(--text-light); border: none; padding: 0.5rem 1rem; border-radius: 99px; cursor: pointer; font-weight: 500; }
        .filter-button.active { background-color: var(--blue-primary); color: white; }
        
        .recommendation-card {
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            border-left: 5px solid;
            position: relative;
        }
        .recommendation-card h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; }
        .recommendation-card ul { padding-left: 1.2rem; list-style-type: disc; }
        .recommendation-card li { margin-bottom: 0.3rem; }
        .recommendation-card::after { /* Category Tag */
            content: attr(data-category);
            position: absolute; top: 1rem; right: 1rem;
            font-size: 0.75rem; font-weight: 500;
            padding: 0.2rem 0.6rem;
            border-radius: 99px;
            color: white;
        }
        /* Card Colors */
        .recommendation-card.lifestyle { border-color: var(--green); background-color: var(--green-bg); }
        .recommendation-card.lifestyle::after { background-color: var(--green); }
        .recommendation-card.medical { border-color: var(--teal); background-color: var(--teal-bg); }
        .recommendation-card.medical::after { background-color: var(--teal); }
        .recommendation-card.monitoring { border-color: var(--yellow); background-color: var(--yellow-bg); }
        .recommendation-card.monitoring::after { background-color: var(--yellow); }
        .recommendation-card.pregnancy { border-color: var(--pink); background-color: var(--pink-bg); }
        .recommendation-card.pregnancy::after { background-color: var(--pink); }
        .recommendation-card.complications { border-color: var(--orange); background-color: var(--orange-bg); }
        .recommendation-card.complications::after { background-color: var(--orange); }
        .recommendation-card.neurological { border-color: var(--indigo); background-color: var(--indigo-bg); }
        .recommendation-card.neurological::after { background-color: var(--indigo); }
        .recommendation-card.future { border-color: var(--red); background-color: var(--red-bg); }
        .recommendation-card.future::after { background-color: var(--red); }
        
        /* --- Disclaimer --- */
        .disclaimer { text-align: center; color: var(--text-light); font-size: 0.875rem; padding: 0 1rem; }

        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            .results-grid, .propkd-results-grid { grid-template-columns: 1fr; }
            .card { padding: 1.5rem; }
            #previousCreatinineList .entry { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header class="hero-header">
        <h1>Your ADPKD Risk Assessment & Road Map</h1>
        <p>Your personalized kidney health journey</p>
    </header>

    <main class="main-container">
        <section class="card">
            <h2>Enter Your Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label for="age">Age (years)</label>
                    <input type="number" id="age" min="1" placeholder="e.g., 42">
                </div>
                <div class="input-group">
                    <label class="radio-group-label">Sex</label>
                    <div class="radio-group">
                        <label><input type="radio" name="sex" value="male" checked> Male</label>
                        <label><input type="radio" name="sex" value="female"> Female</label>
                    </div>
                </div>
                <div class="input-group">
                     <label for="weight">Weight (kg)</label>
                     <input type="number" id="weight" name="weight" min="1" placeholder="e.g., 75">
                </div>
            </div>
        </section>

        <section class="card">
            <h2>Enter Your Creatinine Values</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label for="currentCreatinine">Current Creatinine (mg/dL)</label>
                    <input type="number" id="currentCreatinine" step="0.01" min="0.1" placeholder="e.g., 1.5">
                </div>
                <div class="input-group">
                    <label for="currentCreatinineMonth">Month</label>
                    <select id="currentCreatinineMonth"></select>
                </div>
                <div class="input-group">
                    <label for="currentCreatinineYear">Year</label>
                    <select id="currentCreatinineYear"></select>
                </div>
            </div>
            
            <h3 style="margin-top: 1.5rem; font-weight:600;">Previous Creatinine Values</h3>
            <div id="previousCreatinineList"></div>
            <button type="button" class="secondary-button" onclick="addPreviousCreatinineEntry()">+ Add Previous Measurement</button>
            <br>
            <button type="button" class="action-button" onclick="calculateAndDisplay()">Calculate Kidney Health</button>
        </section>

        <section class="card" id="resultsCard" style="display: none;">
            <h2>Your Kidney Health Snapshot</h2>
            <div class="results-grid">
                <div class="egfr-display">
                    <h3>Current eGFR</h3>
                    <p class="value" id="currentEgfrResult">-</p>
                    <h3>Annual eGFR Decline</h3>
                    <p class="value" id="annualEgfrDeclineResult" style="font-size: 1.8rem;">-</p>
                    <p id="rapidProgressorAlert" style="color:var(--red); font-weight:600;"></p>
                </div>
                <div class="ckd-stages-display">
                     <h3>CKD Stage</h3>
                    <div id="ckdStagesContainer" class="ckd-stages-container">
                    </div>
                </div>
            </div>
        </section>
        
        <section class="card">
            <h2>PROPKD Risk Score Calculator</h2>
            <p style="margin-top:-1rem; margin-bottom:1.5rem; color: var(--text-light);">This score helps predict the risk of End-Stage Renal Disease (ESRD) for patients with PKD1/PKD2 mutations.</p>
            <div class="form-grid">
                 <div class="input-group">
                    <label for="hypertensionBefore35">Hypertension before age 35?</label>
                    <select id="hypertensionBefore35">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="urologicEventBefore35">First urologic event before age 35?*</label>
                    <select id="urologicEventBefore35">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                 <div class="input-group">
                    <label for="mutationType">Genetic Mutation Type (if known)</label>
                    <select id="mutationType">
                        <option value="unknown">Unknown / Not tested</option>
                        <option value="pkd2">PKD2 mutation</option>
                        <option value="nontrunc_pkd1">Nontruncating PKD1 mutation</option>
                        <option value="trunc_pkd1">Truncating PKD1 mutation</option>
                    </select>
                </div>
            </div>
             <small style="display:block; margin-top: 0.5rem; color: var(--text-light);">*Urologic event: kidney infection, flank pain, hematuria, cyst hemorrhage, or kidney stone.</small>

            <button type="button" class="action-button" onclick="calculateAndDisplayPROPKD()" style="margin-top:1.5rem;">Calculate PROPKD Score</button>
            
            <div id="propkdResultsArea" style="display:none;">
                <div class="propkd-results-grid">
                    <div class="propkd-breakdown">
                        <h3>Score Calculation</h3>
                        <div id="propkd_male"><span>Sex (Male)</span><span>-</span></div>
                        <div id="propkd_htn"><span>Hypertension < 35y</span><span>-</span></div>
                        <div id="propkd_event"><span>Urologic Event < 35y</span><span>-</span></div>
                        <div id="propkd_mutation"><span>Mutation Type</span><span>-</span></div>
                        <div><span class="total">TOTAL SCORE</span><span class="total" id="propkdScoreResult">-</span></div>
                    </div>
                    <div class="propkd-risk-profile">
                        <h3>Your Risk Profile</h3>
                        <p><span id="propkdRiskLevelTag" class="risk-level-tag">-</span></p>
                        <p id="propkdRiskProfileResult" style="color: var(--text-light)"></p>
                    </div>
                </div>
            </div>
        </section>

        <section class="card" id="recommendationsCard" style="display: none;">
            <h2>Personalized Recommendations</h2>
             <div class="filter-buttons" id="recommendationFilters">
                </div>
            <div id="recommendationsArea">
                </div>
        </section>
        
        <p class="disclaimer"><strong>Disclaimer:</strong> Recommendations are based on current KDIGO (Kidney Disease: Improving Global Outcomes) guidelines for ADPKD and other cited research. This tool is for educational and informational purposes only and does not constitute medical advice. Always consult with qualified healthcare professionals for medical decisions and patient-specific management, as they can consider your individual medical history and circumstances. The PROPKD score is a predictive tool, and actual outcomes can vary.</p>

    </main>

    <script>
        // --- CONFIG & SETUP ---
        const CURRENT_YEAR = new Date().getFullYear();
        const CURRENT_MONTH = new Date().getMonth(); // 0-indexed
        const MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        let creatinineEntryCounter = 0;

        // --- RECOMMENDATION DATABASE ---
        const ALL_RECOMMENDATIONS = [
            // Lifestyle
            { category: 'Lifestyle', title: 'Physical Activity', points: [
                'Undertake moderate-intensity physical activity for a cumulative duration of at least 150 minutes per week.',
                'Adjust activity level based on cardiovascular and physical tolerance.',
                'Consider activities like walking, swimming, or cycling that are gentle on joints.',
                'Consult with healthcare provider before starting new exercise regimen.'
            ]},
            { category: 'Lifestyle', title: 'Diet and Nutrition', isDynamic: true, points: [] }, // Points are generated dynamically
            { category: 'Lifestyle', title: 'Tobacco Use', points: [
                'Avoid smoking - strong risk factor for intracranial aneurysm (ICA) development and rupture.',
                'Seek support for smoking cessation if needed.',
                'Avoid secondhand smoke exposure.'
            ]},
            { category: 'Lifestyle', title: 'Alcohol Consumption', points: [
                'All people with ADPKD should be asked about their use of alcohol.',
                'Consume ‚â§1 alcoholic drink per day for women or ‚â§2 drinks per day for men.'
            ]},

            // Neurological
            { category: 'Neurological', title: 'Intracranial Aneurysm (ICA) Awareness', points: [
                'Informing adults with ADPKD about increased risk for intracranial aneurysms (ICA) and subarachnoid hemorrhage (SAH).',
                'All people with ADPKD should be educated to recognize thunderclap headache (severe sudden-onset headache reaching maximum intensity within seconds to a minute) which should prompt immediate medical attention.',
                'Seek immediate medical attention if a thunderclap headache occurs.',
                'Be aware of other neurological symptoms: confusion, neck stiffness, sensitivity to light.',
                'Report any unusual neurological symptoms to your healthcare provider promptly.'
            ]},

            // Monitoring
            { category: 'Monitoring', title: 'Aneurysm Screening', points: [
                'Recommend screening for ICA in people with a personal history of SAH or a positive family history of ICA, SAH, or unexplained sudden death.',
                'Time-of-flight (TOF) magnetic resonance angiography (MRA) without gadolinium enhancement should be the method of imaging when screening.',
                'Screening for aortic aneurysms may be considered if there is a familial history of aortic root or thoracic aortic aneurysms.',
                'It is important to exclude the diagnosis of ADPKD in potential living-related kidney donors.',
                'Family members should be appropriately screened before donation.',
                'Genetic counseling may be recommended.'
            ]},
            { category: 'Monitoring', title: 'Advanced CKD Management', minStage: 4, points: [
                'Referral to nephrology if not already under specialist care.',
                'Monitoring for metabolic bone disease.',
                'Dietary phosphorus restriction may be necessary.',
                'Regular monitoring for anemia and appropriate management.'
            ]},

            // Medical
            { category: 'Medical', title: 'Blood Pressure Control (CKD G1-G2, aged 18-49)', condition: (data) => data.age >= 18 && data.age <= 49 && (data.ckdStage === 'G1' || data.ckdStage === 'G2'), points: [
                'For ADPKD patients aged 18‚Äì49 years with CKD G1-G2, target blood pressure (BP) should be ‚â§110/75 mm Hg.'
            ]},
            { category: 'Medical', title: 'Blood Pressure Control (CKD G3-G5, aged ‚â•50)', condition: (data) => data.age >= 50 && (data.ckdStage === 'G3a' || data.ckdStage === 'G3b' || data.ckdStage === 'G4' || data.ckdStage === 'G5'), points: [
                'For ADPKD patients aged ‚â•50 years with CKD G3-G5, a target mean systolic blood pressure (SBP) <120 mm Hg is suggested.'
            ]},
            { category: 'Medical', title: 'General Blood Pressure Management', points: [
                'Regular home blood pressure monitoring is recommended.',
                'Consider ACE inhibitors or ARBs as first-line therapy.',
                'Lifestyle modifications like reduced salt intake, regular exercise, and stress management are crucial.'
            ]},
            { category: 'Medical', title: 'Tolvaptan Therapy', condition: (data) => {
                const age = data.age;
                const egfr = data.egfr;
                const annualDecline = data.annualDecline; // Assuming this is calculated
                const propkdScore = data.propkdScore; // Assuming this is calculated
                const ckdStage = data.ckdStage;

                // Check for rapid progression criteria
                const isRapidProgressor = (annualDecline !== null && annualDecline >= 3) || // Confirmed annual eGFR decline >=3
                                          (ckdStage && (ckdStage === 'G3a' || ckdStage === 'G3b' || ckdStage === 'G4' || ckdStage === 'G5') && age < 45) || // CKD G3-G5 before age 45 years
                                          (propkdScore !== null && propkdScore > 6); // PROPKD score > 6
                // Additional rapid progression indicators from user input that cannot be assessed with current inputs:
                // kidney length ‚â• 16.5 cm (‚â§ 46 years)
                // total kidney volume ‚â• 750 ml (TKV) (‚â§ 50 years)
                // Mayo imaging Class 1-E

                const isEligibleForTolvaptan = age >= 18 && age <= 55 && egfr !== null && egfr >= 25 && isRapidProgressor;

                return isEligibleForTolvaptan;
            }, points: [
                'Initiate tolvaptan treatment in adults with ADPKD aged 18-55 years with an estimated glomerular filtration rate (eGFR) ‚â•25 ml/min/1.73 m2 who have or are at risk for rapidly progressive disease.',
                'Rapid disease progression is defined as reaching or expected to reach kidney failure due to autosomal dominant polycystic kidney disease (ADPKD) before the age of ~60 years.',
                'Confirmed annual eGFR decline ‚â•3 ml/min per 1.73 m2 (based on ‚â•5 measurements over a period of ‚â•5 years OR if a person with ADPKD has CKD G3-G5 before age 45 years).',
                'Other indicators of rapid progression may include kidney length ‚â• 16.5 cm (‚â§ 46 years), total kidney volume ‚â• 750 ml (TKV) (‚â§ 50 years), Mayo imaging Class 1-E, or PROPKD score > 6.',
                'Tolvaptan should be initiated with a daily dose of 45 mg upon waking and 15 mg 8 hours later.',
                'Uptitrating to a target daily dose of 90 mg upon waking and 30 mg 8 hours later should generally be the goal of therapy in all people with ADPKD.',
                'Regular liver function monitoring is required while on therapy.',
                'Ensure adequate hydration to manage increased thirst.',
                'Tolvaptan is contraindicated in cases of elevated liver enzymes, hypersensitivity, volume depletion, uncorrected hypernatraemia (> 145 mmol/L), inability to perceive or respond to thirst, pregnancy, breastfeeding, or anuria.',
                'Discuss all benefits and risks with your nephrologist.'
            ]},
            { category: 'Medical', title: 'Anemia Management', minStage: 3.1, points: [
                'Regular monitoring for anemia is needed in CKD Stage 3 and beyond.',
                'Hypoxia-inducible factor-prolyl hydroxylase inhibitors (HIF-PHI) should not routinely be used to manage anemia in people with ADPKD who are not receiving dialysis.',
                'Iron supplementation may be recommended if deficient.'
            ]},
            { category: 'Medical', title: 'Diabetes Management', minStage: 3.1, points: [
                'Management of diabetes should follow standard CKD guidelines.',
                'Sodium glucose cotransporter-2 inhibitors (SGLT2i) are not recommended at this time to be used to manage diabetes in people with ADPKD.',
                'Regular monitoring of blood glucose levels is essential.'
            ]},
            { category: 'Medical', title: 'CKD Management (General)', minStage: 3.1, points: [
                'Regular monitoring of electrolytes, calcium, and phosphorus.',
                'Consider vitamin D supplementation if deficient.',
                'Avoid nephrotoxic medications including NSAIDs.',
                'Manage anemia and diabetes according to specific ADPKD guidelines (see other cards).'
            ]},

            // Complications
            { category: 'Complications', title: 'Nephrolithiasis (Kidney Stones) Management', points: [
                'People with ADPKD and kidney stones should undergo 24 hour urinary testing.',
                'All stone formers should be counselled to achieve a daily urine output of 2.5 L/d.',
                'People with ADPKD should not be treated for asymptomatic hyperuricemia.',
                'Discuss any history of kidney stones with your doctor.',
                'Dietary modifications may be considered if you have a history of stones.',
                'Seek prompt medical attention for symptoms of kidney stones (e.g., severe flank pain, blood in urine).'
            ]},
            { category: 'Complications', title: 'Hematuria Management', points: [
                'Counselling & Reassurance in case of Gross Hematuria.'
            ]},
            { category: 'Complications', title: 'Urinary Tract Infection (UTI) Management', points: [
                'Clinicians should not treat asymptomatic bacteriuria (ASB) in patients with ADPKD.'
            ]},
            { category: 'Complications', title: 'Cyst Infection Management', points: [
                'In people with ADPKD and kidney cyst infection, treatment with 4‚Äì6 weeks of antibiotic therapy is suggested.'
            ]},
            { category: 'Complications', title: 'Polycystic Liver Disease (PLD)', points: [
                'Be aware that estrogen exposure (e.g., from contraceptives or hormone therapy) may increase the risk of PLD progression.',
                'Discuss hormone replacement therapy risks with your doctor.',
                'Report symptoms like abdominal pain, fullness, or feeling full early during meals.'
            ]},

            // Pregnancy
            { category: 'Pregnancy', title: 'Contraception & PLD', condition: (data) => data.sex === 'female', points: [
                'Discuss contraceptive choices with your doctor, as estrogen and possibly progesterone exposure may be associated with an increased risk of Polycystic Liver Disease (PLD) progression.'
            ]},
            { category: 'Pregnancy', title: 'Pregnancy Planning', condition: (data) => data.sex === 'female', points: [
                'If planning pregnancy, use of tolvaptan and other potentially harmful drugs should be stopped prior to conception and not restarted until breastfeeding is completed.',
                'Discuss all medications with your doctor.'
            ]},
            { category: 'Pregnancy', title: 'Pregnancy & Aspirin', condition: (data) => data.sex === 'female', points: [
                'For pregnant women with ADPKD, low-dose aspirin (75‚Äì150 mg daily) may be prescribed by your doctor from week 12 to week 36 to reduce the risk of pre-eclampsia.'
            ]}
        ];

        // --- DOMContentLoaded: Initial page setup ---
        document.addEventListener('DOMContentLoaded', () => {
            populateDateDropdowns('currentCreatinineMonth', 'currentCreatinineYear', true);
        });

        function populateDateDropdowns(monthId, yearId, isCurrent) {
            const monthEl = document.getElementById(monthId);
            const yearEl = document.getElementById(yearId);

            MONTHS.forEach((month, index) => monthEl.add(new Option(month, index)));

            for (let i = 0; i < 20; i++) {
                yearEl.add(new Option(CURRENT_YEAR - i, CURRENT_YEAR - i));
            }
            if(isCurrent) {
                monthEl.value = CURRENT_MONTH;
                yearEl.value = CURRENT_YEAR;
            }
        }

        // --- DYNAMICALLY ADD/REMOVE CREATININE ENTRIES ---
        function addPreviousCreatinineEntry() {
            creatinineEntryCounter++;
            const list = document.getElementById('previousCreatinineList');
            const entry = document.createElement('div');
            entry.className = 'entry';
            entry.id = `entry-${creatinineEntryCounter}`;
            entry.innerHTML = `
                <div class="input-group">
                    <label for="prev_creat_val_${creatinineEntryCounter}">Creatinine (mg/dL)</label>
                    <input type="number" class="prev_creat_val" id="prev_creat_val_${creatinineEntryCounter}" step="0.01" min="0.1" placeholder="e.g., 1.2">
                </div>
                <div class="input-group">
                    <label for="prev_creat_month_${creatinineEntryCounter}">Month</label>
                    <select class="prev_creat_month" id="prev_creat_month_${creatinineEntryCounter}"></select>
                </div>
                <div class="input-group">
                    <label for="prev_creat_year_${creatinineEntryCounter}">Year</label>
                    <select class="prev_creat_year" id="prev_creat_year_${creatinineEntryCounter}"></select>
                </div>
                <button type="button" class="delete-btn" onclick="removeCreatinineEntry('${entry.id}')">üóëÔ∏è</button>
            `;
            list.appendChild(entry);
            populateDateDropdowns(`prev_creat_month_${creatinineEntryCounter}`, `prev_creat_year_${creatinineEntryCounter}`, false);
        }

        function removeCreatinineEntry(id) {
            document.getElementById(id).remove();
        }

        // --- CALCULATE GFR & DISPLAY RESULTS ---
        function calculateAndDisplay() {
            const age = parseInt(document.getElementById('age').value);
            const sex = document.querySelector('input[name="sex"]:checked').value;
            const weight = parseFloat(document.getElementById('weight').value); // Assuming weight is in kg
            const currentCreatinine = parseFloat(document.getElementById('currentCreatinine').value);
            const currentMonth = parseInt(document.getElementById('currentCreatinineMonth').value);
            const currentYear = parseInt(document.getElementById('currentCreatinineYear').value);

            if (!age || !currentCreatinine || isNaN(age) || isNaN(currentCreatinine)) {
                alert('Please enter valid Age and Current Creatinine values.');
                return;
            }

            const creatinineReadings = [{
                value: currentCreatinine,
                month: currentMonth,
                year: currentYear
            }];

            document.querySelectorAll('.prev_creat_val').forEach((input, index) => {
                const val = parseFloat(input.value);
                const month = parseInt(document.querySelectorAll('.prev_creat_month')[index].value);
                const year = parseInt(document.querySelectorAll('.prev_creat_year')[index].value);
                if (val && !isNaN(val)) {
                    creatinineReadings.push({ value: val, month, year });
                }
            });

            // Sort readings by date ascending for accurate decline calculation
            creatininineReadings.sort((a, b) => {
                if (a.year !== b.year) return a.year - b.year;
                return a.month - b.month;
            });

            const currentEgfr = calculateEgfr(currentCreatinine, age, sex, weight);
            document.getElementById('currentEgfrResult').textContent = `${currentEgfr.toFixed(2)} ml/min/1.73m¬≤`;

            const ckdStage = getCKDStage(currentEgfr);
            displayCKDStages(ckdStage);

            let annualDecline = null;
            if (creatinineReadings.length >= 2) {
                annualDecline = calculateAnnualEgfrDecline(creatinineReadings, age, sex, weight);
                document.getElementById('annualEgfrDeclineResult').textContent = `${annualDecline.toFixed(2)} ml/min/1.73m¬≤/year`;
            } else {
                document.getElementById('annualEgfrDeclineResult').textContent = 'More data needed for annual decline.';
            }

            const rapidProgressorAlert = document.getElementById('rapidProgressorAlert');
            if (annualDecline !== null && annualDecline >= 3) {
                rapidProgressorAlert.textContent = 'Consideration for Tolvaptan therapy - Discuss eligibility with Nephrologist.';
            } else {
                rapidProgressorAlert.textContent = ''; // Clear alert if not rapid progressor
            }


            document.getElementById('resultsCard').style.display = 'block';
            document.getElementById('recommendationsCard').style.display = 'block';

            // Gather all data for recommendations
            const dataForRecommendations = {
                age: age,
                sex: sex,
                egfr: currentEgfr,
                annualDecline: annualDecline,
                ckdStage: ckdStage,
                propkdScore: null // PROPKD score calculated separately
            };

            displayRecommendations(dataForRecommendations);
        }

        function calculateEgfr(creatinine, age, sex, weight) {
            // Using CKD-EPI Creatinine Equation (2009)
            let kappa = sex === 'female' ? 0.7 : 0.9;
            let alpha = sex === 'female' ? -0.329 : -0.411;
            let egfr = 141 * Math.pow(Math.min(creatinine / kappa, 1), alpha) *
                       Math.pow(Math.max(creatinine / kappa, 1), -1.209) *
                       Math.pow(0.993, age);

            if (sex === 'female') {
                egfr *= 1.018;
            }
            // No race factor in current KDIGO ADPKD guidelines
            return egfr;
        }

        function calculateAnnualEgfrDecline(readings, age, sex, weight) {
            if (readings.length < 2) return null;

            let totalDecline = 0;
            let totalYears = 0;

            for (let i = 0; i < readings.length - 1; i++) {
                const egfr1 = calculateEgfr(readings[i].value, age, sex, weight);
                const egfr2 = calculateEgfr(readings[i+1].value, age, sex, weight);

                const date1 = new Date(readings[i].year, readings[i].month);
                const date2 = new Date(readings[i+1].year, readings[i+1].month);

                const yearsDiff = (date2 - date1) / (1000 * 60 * 60 * 24 * 365.25);

                if (yearsDiff > 0) {
                    totalDecline += (egfr1 - egfr2);
                    totalYears += yearsDiff;
                }
            }

            if (totalYears === 0) return 0;
            return totalDecline / totalYears;
        }


        function getCKDStage(egfr) {
            if (egfr >= 90) return 'G1';
            if (egfr >= 60) return 'G2';
            if (egfr >= 45) return 'G3a';
            if (egfr >= 30) return 'G3b';
            if (egfr >= 15) return 'G4';
            return 'G5';
        }

        function displayCKDStages(activeStage) {
            const container = document.getElementById('ckdStagesContainer');
            container.innerHTML = ''; // Clear previous stages

            const stages = ['G1', 'G2', 'G3a', 'G3b', 'G4', 'G5'];
            stages.forEach(stage => {
                const pill = document.createElement('span');
                pill.className = `ckd-stage-pill ${stage}`;
                if (stage === activeStage) {
                    pill.classList.add('active');
                }
                pill.textContent = `CKD G${stage.charAt(1)}${stage.length > 2 ? stage.charAt(2).toUpperCase() : ''}`;
                container.appendChild(pill);
            });
        }

        // --- PROPKD Score Calculation ---
        function calculateAndDisplayPROPKD() {
            const age = parseInt(document.getElementById('age').value);
            const sex = document.querySelector('input[name="sex"]:checked').value;
            const hypertensionBefore35 = document.getElementById('hypertensionBefore35').value;
            const urologicEventBefore35 = document.getElementById('urologicEventBefore35').value;
            const mutationType = document.getElementById('mutationType').value;

            if (!age || isNaN(age)) {
                alert('Please enter a valid Age for PROPKD Score calculation.');
                return;
            }

            let score = 0;
            const scores = { male: 0, htn: 0, event: 0, mutation: 0 };

            // Age is implicitly handled by the risk categories, but some factors depend on it.
            // PROPKD score components:
            // 1. Male sex
            if (sex === 'male') {
                score += 1;
                scores.male = 1;
            }

            // 2. Hypertension before age 35
            if (hypertensionBefore35 === 'yes') {
                score += 2;
                scores.htn = 2;
            }

            // 3. First urologic event before age 35
            if (urologicEventBefore35 === 'yes') {
                score += 2;
                scores.event = 2;
            }

            // 4. Genetic mutation type
            if (mutationType === 'nontrunc_pkd1') {
                score += 2;
                scores.mutation = 2;
            } else if (mutationType === 'trunc_pkd1') {
                score += 4;
                scores.mutation = 4;
            } else if (mutationType === 'pkd2') {
                // PKD2 mutation adds 0 points to PROPKD score relative to unknown/non-PKD1
                scores.mutation = 0;
            } else if (mutationType === 'unknown') {
                 // Unknown mutation adds 0 points
                scores.mutation = 0;
            }


            document.getElementById('propkd_male').children[1].textContent = `${scores.male} points`;
            document.getElementById('propkd_htn').children[1].textContent = `${scores.htn} points`;
            document.getElementById('propkd_event').children[1].textContent = `${scores.event} points`;
            document.getElementById('propkd_mutation').children[1].textContent = `${scores.mutation} points`;
            document.getElementById('propkdScoreResult').textContent = score;

            let riskProfile = '', riskClass = '';
            if (score <= 3) { riskProfile = 'Low Risk (Median age for ESRD: ~70.6 years)'; riskClass = 'low'; }
            else if (score <= 6) { riskProfile = 'Intermediate Risk (Median age for ESRD: ~56.9 years)'; riskClass = 'intermediate'; }
            else { riskProfile = 'High Risk (Median age for ESRD: ~49 years)'; riskClass = 'high'; }

            const tagEl = document.getElementById('propkdRiskLevelTag');
            tagEl.textContent = riskClass.charAt(0).toUpperCase() + riskClass.slice(1) + " Risk";
            tagEl.className = `risk-level-tag ${riskClass}`;
            let profileText = riskProfile;
            if (mutation === 'unknown') profileText += ' *Provisional assessment as mutation type is unknown.*';
            document.getElementById('propkdRiskProfileResult').textContent = profileText;
            document.getElementById('propkdResultsArea').style.display = 'block';

            // Update recommendations with PROPKD score
            const dataForRecommendations = {
                age: age,
                sex: sex,
                egfr: parseFloat(document.getElementById('currentEgfrResult').textContent),
                annualDecline: parseFloat(document.getElementById('annualEgfrDeclineResult').textContent),
                ckdStage: getCKDStage(parseFloat(document.getElementById('currentEgfrResult').textContent)),
                propkdScore: score
            };
            displayRecommendations(dataForRecommendations);
        }

        // --- DISPLAY RECOMMENDATIONS ---
        function displayRecommendations(data) {
            const recommendationsArea = document.getElementById('recommendationsArea');
            recommendationsArea.innerHTML = ''; // Clear previous recommendations
            
            const filterButtonsContainer = document.getElementById('recommendationFilters');
            filterButtonsContainer.innerHTML = ''; // Clear previous filters

            const allCategories = ['All', ...new Set(ALL_RECOMMENDATIONS.map(rec => rec.category))];
            
            allCategories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'filter-button';
                button.textContent = category;
                button.dataset.category = category;
                button.onclick = () => filterRecommendations(category, data);
                filterButtonsContainer.appendChild(button);
            });

            // Set 'All' as active by default
            filterButtonsContainer.querySelector('[data-category="All"]').classList.add('active');
            
            filterRecommendations('All', data); // Display all recommendations initially
        }

        function filterRecommendations(selectedCategory, data) {
            const recommendationsArea = document.getElementById('recommendationsArea');
            recommendationsArea.innerHTML = '';

            // Update active state of filter buttons
            document.querySelectorAll('.filter-button').forEach(button => {
                if (button.dataset.category === selectedCategory) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            ALL_RECOMMENDATIONS.forEach(rec => {
                if (selectedCategory === 'All' || rec.category === selectedCategory) {
                    // Check conditions
                    let showRecommendation = true;

                    if (rec.minStage && data.egfr !== null) {
                        const currentCkdStageNum = parseFloat(data.ckdStage.replace('G','').replace('a','').replace('b',''));
                        if (currentCkdStageNum < rec.minStage) {
                            showRecommendation = false;
                        }
                    }

                    if (rec.condition && !rec.condition(data)) {
                        showRecommendation = false;
                    }

                    if (showRecommendation) {
                        const card = document.createElement('div');
                        card.className = `recommendation-card ${rec.category.toLowerCase()}`;
                        card.dataset.category = rec.category; // For CSS ::after content

                        let pointsHtml = '';
                        if (rec.isDynamic) {
                            pointsHtml = generateDynamicDietPoints(data.egfr); // Generate dynamic points
                        } else {
                            pointsHtml = `<ul>${rec.points.map(p => `<li>${p}</li>`).join('')}</ul>`;
                        }
                        
                        card.innerHTML = `
                            <h3>${rec.title}</h3>
                            ${pointsHtml}
                        `;
                        recommendationsArea.appendChild(card);
                    }
                }
            });

            if (recommendationsArea.children.length === 0) {
                recommendationsArea.innerHTML = '<p style="text-align: center; color: var(--text-light);">No recommendations for this category based on the provided information.</p>';
            }
        }

        function generateDynamicDietPoints(egfr) {
            let dietPoints = [
                'Maintain a balanced diet rich in fruits, vegetables, and whole grains.',
                'Limit processed foods, sugary drinks, and unhealthy fats.'
            ];

            if (egfr < 60) { // CKD Stage 3 or worse
                dietPoints.push('Discuss protein intake with your doctor or a renal dietitian; a moderate protein diet may be beneficial.');
                dietPoints.push('Monitor sodium intake to help manage blood pressure.');
                dietPoints.push('Be mindful of potassium and phosphorus intake, especially as eGFR declines further; your doctor may advise specific restrictions.');
            } else {
                dietPoints.push('Sodium restriction is generally advised to help manage blood pressure and reduce kidney burden.');
            }

            return `<ul>${dietPoints.map(p => `<li>${p}</li>`).join('')}</ul>`;
        }

    </script>
</body>
</html>
