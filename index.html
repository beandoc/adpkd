<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADPKD Risk Assessment & Road Map</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- jsPDF and html2canvas for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Chart.js for eGFR Graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>


    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .focus-ring:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }
        .custom-radio input[type="radio"] { display: none; }
        .custom-radio label {
            cursor: pointer;
            border: 1px solid #e2e8f0; /* slate-200 */
            transition: all 0.2s ease-in-out;
        }
        .custom-radio input[type="radio"]:checked + label {
            background-color: #eff6ff; /* blue-50 */
            border-color: #3b82f6; /* blue-500 */
            color: #2563eb; /* blue-600 */
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* eGFR Slider Styling */
        #egfrSlider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 12px;
            border-radius: 6px;
             /* Green to Red gradient */
            background: linear-gradient(to right, #22c55e, #84cc16, #eab308, #f59e0b, #ef4444);
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
            direction: rtl; /* Makes slider move left-to-right for decreasing values */
        }
        #egfrSlider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 24px; height: 24px;
            background: #ffffff;
            border: 2px solid #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        #egfrSlider::-moz-range-thumb {
            width: 24px; height: 24px;
            background: #ffffff;
            border: 2px solid #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Header Section -->
    <header class="bg-gradient-to-br from-slate-800 to-slate-900 text-white py-12 md:py-20 px-4 text-center">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl md:text-5xl font-bold tracking-tight">Your ADPKD Health Dashboard</h1>
            <p class="mt-4 text-lg md:text-xl text-slate-300">A personalized tool to understand your kidney health and navigate your journey with ADPKD.</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto p-4 md:p-8 -mt-16 relative z-10">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Patient Information Card -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold flex items-center gap-3"><i data-lucide="user-round"></i>Patient Information</h2>
                    <div class="mt-6 space-y-4">
                        <div>
                             <label for="patientName" class="block text-sm font-medium text-slate-600 mb-1">Patient Name</label>
                             <input type="text" id="patientName" placeholder="e.g., Jane Doe" class="w-full p-2 border border-slate-300 rounded-lg focus-ring">
                        </div>
                        <div>
                            <label for="age" class="block text-sm font-medium text-slate-600 mb-1">Age (years)</label>
                            <input type="number" id="age" min="1" placeholder="e.g., 42" class="w-full p-2 border border-slate-300 rounded-lg focus-ring">
                        </div>
                        <div>
                            <label for="weight" class="block text-sm font-medium text-slate-600 mb-1">Weight (kg)</label>
                            <input type="number" id="weight" min="1" placeholder="e.g., 75" class="w-full p-2 border border-slate-300 rounded-lg focus-ring">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-2">Sex</label>
                            <div class="grid grid-cols-2 gap-2 custom-radio">
                                <input type="radio" id="sex-male" name="sex" value="male" checked>
                                <label for="sex-male" class="text-center font-semibold p-3 rounded-lg flex items-center justify-center gap-2"><i data-lucide="male"></i> Male</label>
                                
                                <input type="radio" id="sex-female" name="sex" value="female">
                                <label for="sex-female" class="text-center font-semibold p-3 rounded-lg flex items-center justify-center gap-2"><i data-lucide="female"></i> Female</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Creatinine Values Card -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold flex items-center gap-3"><i data-lucide="beaker"></i>Creatinine Values</h2>
                    <p class="text-xs text-slate-500 mt-1">Enter at least two values (current and one past) to calculate your eGFR decline rate.</p>
                    <div class="mt-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Current Creatinine (mg/dL)</label>
                            <div class="grid grid-cols-3 gap-2">
                                <input type="number" id="currentCreatinine" step="0.01" min="0.1" placeholder="e.g., 1.5" class="col-span-3 p-2 border border-slate-300 rounded-lg focus-ring">
                                <select id="currentCreatinineMonth" class="p-2 border border-slate-300 rounded-lg focus-ring"></select>
                                <select id="currentCreatinineYear" class="col-span-2 p-2 border border-slate-300 rounded-lg focus-ring"></select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Previous Values</label>
                            <div id="previousCreatinineList" class="space-y-3"></div>
                            <button type="button" onclick="addPreviousCreatinineEntry()" class="w-full mt-2 text-sm text-blue-600 hover:text-blue-800 font-semibold p-2 rounded-lg flex items-center justify-center gap-2 bg-blue-50 hover:bg-blue-100 transition-colors">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> Add Previous Measurement
                            </button>
                        </div>
                    </div>
                </div>

                <!-- PROPKD Score Card -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold flex items-center gap-3"><i data-lucide="shield-check"></i>PROPKD Risk Score</h2>
                    <div class="mt-6 space-y-4">
                        <div>
                            <label for="hypertensionBefore35" class="block text-sm font-medium text-slate-600 mb-1">Hypertension before age 35?</label>
                            <select id="hypertensionBefore35" class="w-full p-2 border border-slate-300 rounded-lg focus-ring"> <option value="no">No</option> <option value="yes">Yes</option> </select>
                        </div>
                        <div>
                            <label for="urologicEventBefore35" class="block text-sm font-medium text-slate-600 mb-1">First urologic event before age 35?*</label>
                            <select id="urologicEventBefore35" class="w-full p-2 border border-slate-300 rounded-lg focus-ring"> <option value="no">No</option> <option value="yes">Yes</option> </select>
                            <p class="text-xs text-slate-400 mt-1">*e.g., kidney infection, hematuria, flank pain.</p>
                        </div>
                        <div>
                            <label for="mutationType" class="block text-sm font-medium text-slate-600 mb-1">Genetic Mutation Type (if known)</label>
                            <select id="mutationType" class="w-full p-2 border border-slate-300 rounded-lg focus-ring">
                                <option value="unknown">Unknown / Not tested</option> <option value="pkd2">PKD2 mutation</option> <option value="nontrunc_pkd1">Nontruncating PKD1</option> <option value="trunc_pkd1">Truncating PKD1</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="space-y-3">
                    <button onclick="calculateAndDisplayAll()" class="w-full text-lg font-bold text-white bg-blue-600 hover:bg-blue-700 p-4 rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-3">
                        <i data-lucide="activity"></i> Generate Health Report
                    </button>
                    <button id="downloadPdfBtn" onclick="downloadReport()" class="w-full text-md font-semibold text-slate-700 bg-slate-200 hover:bg-slate-300 p-3 rounded-xl transition-all flex items-center justify-center gap-3 hidden">
                        <i data-lucide="download"></i> Download Health Snapshot (PDF)
                    </button>
                </div>
            </div>

            <!-- Right Column: Results & Recommendations -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Results Card -->
                <div id="resultsCard" class="bg-white p-6 rounded-xl shadow-lg hidden">
                    <h2 class="text-xl font-bold flex items-center gap-3"><i data-lucide="bar-chart-3"></i>Your Kidney Health Snapshot</h2>
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- eGFR Display -->
                        <div class="bg-slate-50 p-4 rounded-lg text-center">
                            <h3 class="font-semibold text-slate-600">Current eGFR</h3>
                            <p id="currentEgfrResult" class="text-5xl font-extrabold text-blue-600 mt-2">-</p>
                            <p class="text-sm text-slate-500">mL/min/1.73m²</p>
                        </div>
                        <!-- eGFR Decline Display -->
                        <div class="bg-slate-50 p-4 rounded-lg text-center">
                            <h3 class="font-semibold text-slate-600">Annual eGFR Decline</h3>
                            <p id="annualEgfrDeclineResult" class="text-3xl font-bold mt-4">-</p>
                            <p id="rapidProgressorAlert" class="text-sm h-5 mt-1 font-semibold"></p>
                        </div>
                    </div>
                    <!-- eGFR Graph -->
                    <div class="mt-6">
                         <h3 class="font-semibold text-slate-600 mb-2">eGFR Trend</h3>
                         <div class="bg-slate-50 p-2 rounded-lg"><canvas id="egfrChart"></canvas></div>
                    </div>
                     <!-- Tolvaptan Alert -->
                    <div id="tolvaptanAlert" class="mt-6 border-2 border-blue-400 bg-blue-50 p-4 rounded-lg hidden"></div>
                     <!-- CKD Stage Display -->
                    <div class="mt-6">
                        <h3 class="font-semibold text-slate-600 mb-2">Chronic Kidney Disease (CKD) Stage</h3>
                        <div id="ckdStagesContainer" class="flex flex-wrap gap-2"></div>
                    </div>
                     <!-- PROPKD Result Display -->
                    <div id="propkdResultsArea" class="mt-8 border-t border-slate-200 pt-6 hidden">
                         <h3 class="font-semibold text-slate-600 mb-4">PROPKD Risk Analysis</h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                             <div id="propkdRiskProfile" class="p-4 rounded-lg text-center">
                                 <p id="propkdRiskLevelTag" class="text-2xl font-bold">-</p>
                                 <p id="propkdRiskProfileResult" class="text-sm text-slate-500 mt-1"></p>
                             </div>
                             <div class="text-sm">
                                 <h4 class="font-semibold mb-2">Score Breakdown</h4>
                                 <div id="propkd_male" class="flex justify-between py-1 border-b"><span>Sex (Male)</span><span class="font-semibold">-</span></div>
                                 <div id="propkd_htn" class="flex justify-between py-1 border-b"><span>Hypertension &lt; 35y</span><span class="font-semibold">-</span></div>
                                 <div id="propkd_event" class="flex justify-between py-1 border-b"><span>Urologic Event &lt; 35y</span><span class="font-semibold">-</span></div>
                                 <div id="propkd_mutation" class="flex justify-between py-1"><span>Mutation Type</span><span class="font-semibold">-</span></div>
                                 <div class="flex justify-between py-2 mt-2 border-t-2">
                                     <span class="font-bold text-base">TOTAL SCORE</span>
                                     <span id="propkdScoreResult" class="font-extrabold text-base text-blue-600">-</span>
                                 </div>
                             </div>
                         </div>
                    </div>
                </div>

                <!-- Future Scenario Planner -->
                <div id="futureScenarioCard" class="bg-white p-6 rounded-xl shadow-lg hidden">
                    <h2 class="text-xl font-bold flex items-center gap-3"><i data-lucide="line-chart"></i>Explore Future Scenarios</h2>
                    <p class="text-sm text-slate-500 mt-2">Move the slider to see how your recommendations may change as eGFR changes over time. The slider starts at your current eGFR and can only be moved to lower values.</p>
                    <div class="mt-4">
                        <input type="range" min="5" max="95" value="95" id="egfrSlider">
                        <div class="flex justify-between text-xs font-medium text-slate-500 mt-1">
                            <span>CKD G1 (≥90)</span>
                            <span>CKD G2</span>
                            <span>CKD G3a</span>
                            <span>CKD G3b</span>
                            <span>CKD G4</span>
                            <span>CKD G5 (&lt;15)</span>
                        </div>
                        <p class="text-center font-semibold mt-2">Future eGFR: <span id="sliderValue" class="text-blue-600">95</span> mL/min/1.73m²</p>
                    </div>
                </div>

                <!-- Recommendations Card -->
                <div id="recommendationsCard" class="bg-white p-6 rounded-xl shadow-lg hidden">
                     <h2 id="recommendationsTitle" class="text-xl font-bold flex items-center gap-3"><i data-lucide="map"></i>Your Personalized Road Map</h2>
                     <div class="my-6 border-b border-slate-200">
                        <div id="recommendationFilters" class="flex flex-wrap gap-2 pb-6"></div>
                     </div>
                     <div id="recommendationsArea" class="space-y-4"></div>
                </div>

                 <!-- Disclaimer -->
                <div class="text-center text-xs text-slate-500 p-4">
                    <strong>Disclaimer:</strong> Recommendations are based on current KDIGO (Kidney Disease: Improving Global Outcomes) guidelines for ADPKD and other cited research. This tool is for educational and informational purposes only and does not constitute medical advice. Always consult with qualified healthcare professionals for medical decisions and patient-specific management, as they can consider your individual medical history and clinical condition.
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- GLOBAL VARIABLES & CONFIG ---
        const { jsPDF } = window.jspdf;
        let egfrChartInstance;
        let patientData = {};
        const CURRENT_YEAR = new Date().getFullYear();
        const CURRENT_MONTH = new Date().getMonth();
        const MONTHS = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        let lastEnteredDate = new Date();
        let creatinineEntryCounter = 0;
        
        const CATEGORY_STYLES = {
            'Lifestyle': { color: 'green', hex: '#ECFDF5', border: '#10B981' }, 
            'Medical': { color: 'sky', hex: '#F0F9FF', border: '#0EA5E9' },
            'Monitoring': { color: 'amber', hex: '#FFFBEB', border: '#F59E0B' }, 
            'Complications': { color: 'orange', hex: '#FFF7ED', border: '#F97316' },
            'Pregnancy': { color: 'pink', hex: '#FDF2F8', border: '#EC4899' }, 
            'Neurological': { color: 'indigo', hex: '#EEF2FF', border: '#4F46E5' },
            'CKD Management': { color: 'purple', hex: '#F5F3FF', border: '#7C3AED' }
        };

        // --- RECOMMENDATION DATABASE ---
        const ALL_RECOMMENDATIONS = [
            // Lifestyle
            { category: 'Lifestyle', title: 'Physical Activity', points: ['Aim for moderate-intensity physical activity for at least 150 minutes per week.'] },
            { category: 'Lifestyle', title: 'Alcohol Consumption', points: ['Avoid alcohol or limit consumption to 1 drink or less per day for women and 2 drinks or less per day for men.'] },
            { category: 'Lifestyle', title: 'Diet and Nutrition', isDynamic: true, points: [] },
            { category: 'Lifestyle', title: 'Tobacco Use', points: ['Avoid smoking, as it is a strong risk factor for intracranial aneurysm (ICA) development and rupture.'] },
            // Neurological
            { category: 'Neurological', title: 'Intracranial Aneurysm (ICA) Awareness', points: ['Be aware of the increased risk for intracranial aneurysms (ICA) and subarachnoid hemorrhage (SAH).', 'Recognize "thunderclap headache" (severe, sudden-onset) and seek immediate medical attention if it occurs.'] },
            // Monitoring
            { category: 'Monitoring', title: 'Screening for ICA', points: ['Screening for ICA is recommended with a personal history of SAH or a family history of ICA, SAH, or unexplained sudden death.', 'Time-of-flight (TOF) magnetic resonance angiography (MRA) without gadolinium is the preferred imaging method.', 'Screening for aortic aneurysms is recommended with a family history of aortic root or thoracic aortic aneurysms.'] },
            { category: 'Monitoring', title: 'Living Donor Considerations', points: ['It is crucial to exclude the diagnosis of ADPKD in potential living-related kidney donors.'] },
            // Medical
            { category: 'Medical', title: 'Blood Pressure Management', isDynamic: true, points: [] },
            { category: 'Medical', title: 'Tolvaptan Therapy', condition: (d) => d.age >= 18 && d.age <= 55 && d.egfr >= 25 && d.isRapidProgressor, 
                points: [
                    'As you meet the primary criteria for rapidly progressive disease, initiating Tolvaptan may be recommended to slow eGFR decline.',
                    'Contraindications include: elevated liver enzymes, volume depletion, hypernatraemia, inability to sense thirst, pregnancy, breastfeeding, or anuria.'
                ],
                subPoints: [
                    '<strong>Additional considerations supporting therapy:</strong>',
                    'Kidney length ≥ 16.5 cm (in ages ≤ 46)',
                    'Total Kidney Volume (TKV) ≥ 750 ml (in ages ≤ 50)',
                    'Mayo Imaging Class 1C, 1D, or 1E',
                    'PROPKD Score > 6'
                ]
            },
            // CKD Management Recommendations by Stage
            { category: 'CKD Management', title: 'CKD Stage 3 Management', minStage: 3.1, maxStage: 3.2, points: ['Regular monitoring of electrolytes, calcium, and phosphorus.', 'Consider vitamin D supplementation if deficient.', 'Anemia management (avoid HIF-PHIs).', 'Avoid nephrotoxic medications including NSAIDs.', 'Management of diabetes should follow CKD guidelines (avoid SGLT2 inhibitors).'] },
            { category: 'CKD Management', title: 'CKD Stage 4 Preparation', minStage: 4, maxStage: 4, points: ['Discussion about kidney replacement therapy options (dialysis, transplant).', 'Evaluation of potential living kidney donors.', 'Recommended vaccinations (Hepatitis B, pneumococcal, influenza).', 'Consider vascular access planning if dialysis is anticipated.', 'Nutritional counseling with a renal dietitian.'] },
            { category: 'CKD Management', title: 'CKD Stage 5 (Kidney Failure) Management', minStage: 5, maxStage: 5, points: ['Preparation for dialysis or transplantation.', 'Vascular access creation (fistula or graft) for hemodialysis.', 'Peritoneal dialysis catheter placement if choosing PD.', 'Transplant evaluation and waitlist registration.', 'Symptom management for uremia.', 'Palliative care discussion if appropriate.'] },
            // Complications
            { category: 'Complications', title: 'Nephrolithiasis (Kidney Stones)', points: ['If you have a history of kidney stones, a 24-hour urinary test is recommended.', 'All stone formers should aim for a daily urine output of 2.5 L/day.', 'Asymptomatic hyperuricemia should not be treated.'] },
            { category: 'Complications', title: 'Hematuria (Blood in Urine)', points: ['Gross hematuria can be alarming but is often manageable. Counseling and reassurance are key first steps.'] },
            { category: 'Complications', title: 'Urinary Tract & Cyst Infections', points: ['Asymptomatic bacteriuria (ASB) should not be treated with antibiotics.', 'Confirmed kidney cyst infections require a 4-6 week course of antibiotic therapy.'] },
            { category: 'Complications', title: 'Polycystic Liver Disease (PLD)', points: ['Be aware that estrogen exposure may increase the risk of PLD progression.'] },
            // Pregnancy
            { category: 'Pregnancy', title: 'Contraception & Pregnancy Planning', sex: 'female', points: ['Discuss contraceptive choices with your doctor, as estrogen may increase Polycystic Liver Disease (PLD) risk.', 'Drugs like Tolvaptan must be stopped before conception and breastfeeding.'] },
            { category: 'Pregnancy', title: 'Pregnancy & Aspirin', sex: 'female', points: ['Low-dose aspirin may be prescribed from week 12 to 36 to reduce pre-eclampsia risk.'] }
        ];

        // --- PAGE INITIALIZATION ---
        window.onload = () => {
            lucide.createIcons();
            lastEnteredDate = new Date();
            populateDateDropdowns('currentCreatinineMonth', 'currentCreatinineYear', lastEnteredDate.getMonth(), lastEnteredDate.getFullYear());
            document.getElementById('egfrSlider').addEventListener('input', updateRecommendationsForSlider);
        };
        
        function populateDateDropdowns(monthId, yearId, selectedMonth, selectedYear) {
            const monthEl = document.getElementById(monthId);
            const yearEl = document.getElementById(yearId);
            monthEl.innerHTML = '';
            yearEl.innerHTML = '';
            MONTHS.forEach((month, index) => monthEl.add(new Option(month, index)));
            for (let i = 0; i < 50; i++) yearEl.add(new Option(CURRENT_YEAR - i, CURRENT_YEAR - i));
            
            monthEl.value = selectedMonth;
            yearEl.value = selectedYear;
        }
        
        // --- DYNAMICALLY ADD/REMOVE CREATININE ENTRIES ---
        function addPreviousCreatinineEntry() {
            creatinineEntryCounter++;
            const list = document.getElementById('previousCreatinineList');
            
            lastEnteredDate.setFullYear(lastEnteredDate.getFullYear() - 1);

            const entry = document.createElement('div');
            entry.className = 'grid grid-cols-12 gap-2 items-center';
            entry.id = `entry-${creatinineEntryCounter}`;
            entry.innerHTML = `<input type="number" step="0.01" class="prev_creat_val col-span-5 p-2 border rounded-lg" id="prev_creat_val_${creatinineEntryCounter}" placeholder="Value"><select class="prev_creat_month col-span-3 p-2 border rounded-lg" id="prev_creat_month_${creatinineEntryCounter}"></select><select class="prev_creat_year col-span-3 p-2 border rounded-lg" id="prev_creat_year_${creatinineEntryCounter}"></select><button type="button" class="col-span-1 text-red-500 hover:text-red-700" onclick="removeEntry('entry-${creatinineEntryCounter}')"><i data-lucide="x-circle" class="w-5 h-5"></i></button>`;
            list.appendChild(entry);
            populateDateDropdowns(`prev_creat_month_${creatinineEntryCounter}`, `prev_creat_year_${creatinineEntryCounter}`, lastEnteredDate.getMonth(), lastEnteredDate.getFullYear());
            lucide.createIcons();
        }
        function removeEntry(id) { document.getElementById(id)?.remove(); }

        // --- CORE CALCULATIONS ---
        function calculateEGFR(creatinine, age, sex) {
            if (isNaN(creatinine) || creatinine <= 0 || isNaN(age) || age <= 0) return NaN;
            const k = (sex === 'female') ? 0.7 : 0.9;
            const a = (sex === 'female') ? -0.241 : -0.302;
            const f = (sex === 'female') ? 1.012 : 1;
            return 142 * Math.pow(Math.min(creatinine / k, 1), a) * Math.pow(Math.max(creatinine / k, 1), -1.200) * Math.pow(0.9938, age) * f;
        }

        function getCKDStageInfo(egfr) {
            if (isNaN(egfr)) return { stage: 'N/A', num: 0, color: 'slate', description: 'Not Available' };
            if (egfr >= 90) return { stage: 'G1', num: 1, color: 'green', description: 'Normal or high' }; 
            if (egfr >= 60) return { stage: 'G2', num: 2, color: 'lime', description: 'Mildly decreased' };
            if (egfr >= 45) return { stage: 'G3a', num: 3.1, color: 'yellow', description: 'Mildly to moderately decreased' }; 
            if (egfr >= 30) return { stage: 'G3b', num: 3.2, color: 'amber', description: 'Moderately to severely decreased' };
            if (egfr >= 15) return { stage: 'G4', num: 4, color: 'orange', description: 'Severely decreased' }; 
            return { stage: 'G5', num: 5, color: 'red', description: 'Kidney failure' };
        }
        
        // --- MAIN CALCULATION & DISPLAY LOGIC ---
        function calculateAndDisplayAll() {
            const name = document.getElementById('patientName').value;
            const age = parseFloat(document.getElementById('age').value);
            const sex = document.querySelector('input[name="sex"]:checked').value;
            const currentCreatinine = parseFloat(document.getElementById('currentCreatinine').value);
            const currentMonth = parseInt(document.getElementById('currentCreatinineMonth').value);
            const currentYear = parseInt(document.getElementById('currentCreatinineYear').value);

            if (isNaN(age) || isNaN(currentCreatinine) || !name) { 
                alert('Please fill in Patient Name, Age, and Current Creatinine.'); 
                return; 
            }

            const currentDate = new Date(currentYear, currentMonth);
            const currentEgfr = calculateEGFR(currentCreatinine, age, sex);
            
            let allPoints = [{ date: currentDate, value: currentEgfr, creatinine: currentCreatinine }];
            document.querySelectorAll('#previousCreatinineList .grid').forEach(entry => {
                const val = parseFloat(entry.querySelector('.prev_creat_val').value);
                const month = parseInt(entry.querySelector('.prev_creat_month').value);
                const year = parseInt(entry.querySelector('.prev_creat_year').value);
                if (!isNaN(val) && val > 0) {
                    const pastDate = new Date(year, month);
                    const ageAtPastDate = age - (currentDate.getTime() - pastDate.getTime()) / (1000 * 3600 * 24 * 365.25);
                    allPoints.push({ date: pastDate, value: calculateEGFR(val, ageAtPastDate, sex), creatinine: val });
                }
            });
            allPoints.sort((a, b) => a.date - b.date);

            let annualDecline = NaN, isRapidProgressor = false, hasSufficientDataForDecline = false;
            const declineResultEl = document.getElementById('annualEgfrDeclineResult');
            const alertEl = document.getElementById('rapidProgressorAlert');
            if (allPoints.length >= 2) {
                const first = allPoints[0], last = allPoints[allPoints.length - 1];
                const timeDiffYears = (last.date - first.date) / (1000 * 3600 * 24 * 365.25);
                
                if (timeDiffYears >= 0.5) { 
                    hasSufficientDataForDecline = true;
                    annualDecline = (first.value - last.value) / timeDiffYears;
                    declineResultEl.textContent = `${annualDecline.toFixed(1)} / year`;
                    isRapidProgressor = annualDecline >= 3.0;
                    alertEl.textContent = isRapidProgressor ? "Rapid Progression Detected" : "Stable Progression";
                    alertEl.className = `text-sm h-5 mt-1 font-semibold ${isRapidProgressor ? 'text-red-600' : 'text-green-600'}`;
                } else {
                    declineResultEl.textContent = "N/A"; alertEl.textContent = "Data span < 6 months"; alertEl.className = 'text-sm h-5 mt-1 font-semibold text-slate-500';
                }
            } else {
                declineResultEl.textContent = "N/A"; alertEl.textContent = "Add past values for trend."; alertEl.className = 'text-sm h-5 mt-1 font-semibold text-slate-500';
            }

            const currentCkdInfo = getCKDStageInfo(currentEgfr);
            
            patientData = { name, age, sex, weight: parseFloat(document.getElementById('weight').value), egfr: currentEgfr, ckdStage: currentCkdInfo.num, ckdInfo: currentCkdInfo, annualDecline, isRapidProgressor, allPoints, hasSufficientDataForDecline };
            
            document.getElementById('currentEgfrResult').textContent = currentEgfr.toFixed(0);
            renderCKDStages(currentCkdInfo.stage);
            drawEgfrChart(allPoints);
            calculateAndDisplayPROPKD();
            displayTolvaptanAlert();
            
            // Setup slider based on current eGFR
            const slider = document.getElementById('egfrSlider');
            const currentEgfrRounded = Math.max(5, Math.ceil(currentEgfr));
            slider.max = currentEgfrRounded;
            slider.value = currentEgfrRounded;
            document.getElementById('sliderValue').textContent = currentEgfrRounded;
            
            // Set initial recommendations
            document.getElementById('recommendationsTitle').innerHTML = `<i data-lucide="map"></i>Your Personalized Road Map`;
            lucide.createIcons();
            generateAndDisplayRecommendations(patientData, 'recommendationsArea', 'recommendationFilters');
            
            // Show result cards
            ['resultsCard', 'futureScenarioCard', 'recommendationsCard', 'downloadPdfBtn'].forEach(id => document.getElementById(id).classList.remove('hidden'));
            ['resultsCard', 'futureScenarioCard', 'recommendationsCard'].forEach(id => document.getElementById(id).classList.add('fade-in'));
            if (window.innerWidth < 1024) document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
        }
        
        function renderCKDStages(activeStage) {
            const container = document.getElementById('ckdStagesContainer');
            container.innerHTML = '';
            [
                { stage: 'G1', text: '≥90' }, { stage: 'G2', text: '60-89' }, { stage: 'G3a', text: '45-59' },
                { stage: 'G3b', text: '30-44' }, { stage: 'G4', text: '15-29' }, { stage: 'G5', text: '<15' }
            ].forEach(s => {
                const isActive = s.stage === activeStage;
                const ckdInfo = getCKDStageInfo(parseFloat(s.text.replace(/[^0-9.]/g, '')));
                const pill = document.createElement('div');
                pill.className = `text-center p-2 rounded-lg border-2 flex-grow ${isActive ? `bg-${ckdInfo.color}-100 border-${ckdInfo.color}-500 scale-110 shadow-lg` : `bg-white border-slate-200`}`;
                pill.innerHTML = `<div class="font-bold text-lg text-slate-800">${s.stage}</div><div class="text-xs text-slate-500">${s.text}</div>`;
                container.appendChild(pill);
            });
        }
        
        function drawEgfrChart(points) {
            const ctx = document.getElementById('egfrChart').getContext('2d');
            if (egfrChartInstance) egfrChartInstance.destroy();
            egfrChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'eGFR',
                        data: points.map(p => ({ x: p.date.getTime(), y: p.value })),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    scales: {
                        x: { type: 'time', time: { unit: 'year', tooltipFormat: 'MMMdualpr' }, title: { display: true, text: 'Date' }},
                        y: { beginAtZero: false, title: { display: true, text: 'eGFR (mL/min/1.73m²)' } }
                    },
                    plugins: { legend: { display: false }, tooltip: { callbacks: { title: (ctx) => new Date(ctx[0].parsed.x).toLocaleDateString() } } }
                }
            });
        }
        
        function calculateAndDisplayPROPKD() {
            const sex = document.querySelector('input[name="sex"]:checked').value;
            const htn = document.getElementById('hypertensionBefore35').value;
            const event = document.getElementById('urologicEventBefore35').value;
            const mutation = document.getElementById('mutationType').value;
            let score = 0;
            const scores = { male: 0, htn: 0, event: 0, mutation: 0 };

            if (sex === 'male') { score += 1; scores.male = 1; }
            if (htn === 'yes') { score += 2; scores.htn = 2; }
            if (event === 'yes') { score += 2; scores.event = 2; }
            if (mutation === 'nontrunc_pkd1') { score += 2; scores.mutation = 2; }
            else if (mutation === 'trunc_pkd1') { score += 4; scores.mutation = 4; }
            
            document.getElementById('propkd_male').children[1].textContent = `${scores.male} pts`;
            document.getElementById('propkd_htn').children[1].textContent = `${scores.htn} pts`;
            document.getElementById('propkd_event').children[1].textContent = `${scores.event} pts`;
            document.getElementById('propkd_mutation').children[1].textContent = `${scores.mutation} pts`;
            document.getElementById('propkdScoreResult').textContent = score;

            let riskProfile = '', riskClass = '', riskColor = '';
            if (score <= 3) { riskProfile = 'Median age at ESKD: ~71y'; riskClass = 'Low Risk'; riskColor = 'green'; }
            else if (score <= 6) { riskProfile = 'Median age at ESKD: ~57y'; riskClass = 'Intermediate Risk'; riskColor = 'amber'; }
            else { riskProfile = 'Median age at ESKD: ~49y'; riskClass = 'High Risk'; riskColor = 'red'; }
            
            const tagEl = document.getElementById('propkdRiskLevelTag');
            tagEl.textContent = riskClass;
            tagEl.className = `text-2xl font-bold text-${riskColor}-600`;
            
            let profileText = riskProfile;
            if (mutation === 'unknown') profileText += ' (Provisional assessment as mutation type is unknown)';
            document.getElementById('propkdRiskProfileResult').textContent = profileText;

            const profileDiv = document.getElementById('propkdRiskProfile');
            profileDiv.className = `p-4 rounded-lg text-center bg-${riskColor}-50 border-2 border-${riskColor}-200`;

            document.getElementById('propkdResultsArea').classList.remove('hidden');
        }

        function displayTolvaptanAlert() {
            const alertBox = document.getElementById('tolvaptanAlert');
            const { age, egfr, isRapidProgressor, hasSufficientDataForDecline } = patientData;
            
            const tolvaptanRec = ALL_RECOMMENDATIONS.find(r => r.title === 'Tolvaptan Therapy');
            const meetsCriteria = tolvaptanRec.condition(patientData);

            let alertHTML = `<h3 class="font-bold text-lg text-blue-800 flex items-center gap-2"><i data-lucide="alert-triangle"></i>Tolvaptan Therapy Alert</h3>`;

            if (!hasSufficientDataForDecline) {
                 alertHTML += `<p class="mt-2 text-sm text-slate-700">Cannot determine eligibility for Tolvaptan. An eGFR decline rate requires at least two measurements spaced over 6 months apart. Please enter sufficient historical data.</p>`;
            } else if (meetsCriteria) {
                alertHTML += `<p class="mt-2 text-sm text-green-800 font-semibold">Based on your age, eGFR of ${egfr.toFixed(0)}, and annual decline of ${patientData.annualDecline.toFixed(1)}, you meet the criteria for consideration of Tolvaptan therapy.</p>`;
                alertHTML += `<p class="mt-2 text-xs text-slate-600">This therapy is recommended to slow kidney function decline in eligible patients. Discuss the risks and benefits with your nephrologist.</p>`;
            } else {
                let reason = [];
                if (age < 18 || age > 55) reason.push(`age is outside the 18-55 range`);
                if (egfr < 25) reason.push(`eGFR is below 25`);
                if (!isRapidProgressor) reason.push(`annual eGFR decline is less than 3 mL/min`);
                alertHTML += `<p class="mt-2 text-sm text-slate-700">You do not currently meet the primary criteria for Tolvaptan therapy. Reason(s): ${reason.join(', ')}.</p>`;
            }
            
            alertBox.innerHTML = alertHTML;
            alertBox.classList.remove('hidden');
            lucide.createIcons();
        }


        function updateRecommendationsForSlider(event) {
            const sliderValue = parseInt(event.target.value);
            document.getElementById('sliderValue').textContent = sliderValue;
            const futureCkdInfo = getCKDStageInfo(sliderValue);
            const futureData = { ...patientData, egfr: sliderValue, ckdStage: futureCkdInfo.num };
            document.getElementById('recommendationsTitle').innerHTML = `<i data-lucide="line-chart"></i>Road Map for a Future eGFR of ${sliderValue}`;
            lucide.createIcons();
            generateAndDisplayRecommendations(futureData, 'recommendationsArea', 'recommendationFilters');
        }

        // --- PDF DOWNLOAD (REBUILT FOR RELIABILITY & VISUALS) ---
        async function downloadReport() {
            const { name, age, egfr, ckdInfo, annualDecline, hasSufficientDataForDecline } = patientData;
            const chartImage = egfrChartInstance.toBase64Image('image/png', 1.0);
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
            
            // --- CONFIG ---
            const margin = 15;
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const contentWidth = pageWidth - (margin * 2);
            let y = margin;
            const lineSpacing = 6;
            const paraSpacing = 10;
            const lineHeightFactor = 1.4;

            // --- HELPER FUNCTIONS ---
            const addHeader = (isFirstPage) => {
                pdf.setFont("helvetica", "bold");
                pdf.setFontSize(20);
                pdf.text("ADPKD Health Snapshot", pageWidth / 2, y, { align: 'center' });
                y += 12;
                 if (isFirstPage) {
                    pdf.setDrawColor(220, 220, 220); // light grey
                    pdf.line(margin, y, pageWidth - margin, y);
                    y += paraSpacing;
                }
            };

            const addFooter = (pageNum) => {
                const footerY = pageHeight - margin + 8;
                pdf.setFont("helvetica", "normal");
                pdf.setFontSize(9);
                pdf.setDrawColor(220, 220, 220);
                pdf.line(margin, pageHeight - margin, pageWidth - margin, pageHeight - margin);
                pdf.text(`Page ${pageNum}`, pageWidth / 2, footerY, { align: 'center' });
                pdf.text(`Report for ${name} | Generated: ${new Date().toLocaleDateString()}`, margin, footerY);
            };

            const checkPageBreak = (heightNeeded) => {
                if (y + heightNeeded > pageHeight - margin) {
                    addFooter(pdf.internal.getNumberOfPages());
                    pdf.addPage();
                    y = margin;
                    addHeader(false);
                }
            };
            
            // --- PAGE 1: HEADER & SUMMARY ---
            addHeader(true);

            pdf.setFont("helvetica", "normal");
            pdf.setFontSize(12);
            const introText = `Dear ${name},\nThis is your kidney health snapshot and list of personalized recommendations. Kindly discuss these with your Nephrologist, as actual therapy may vary based on your overall clinical condition.`;
            const splitIntro = pdf.splitTextToSize(introText, contentWidth);
            pdf.text(splitIntro, margin, y, { lineHeightFactor: lineHeightFactor });
            y += (splitIntro.length * lineSpacing * lineHeightFactor) + paraSpacing;

            // --- Summary Section ---
            checkPageBreak(50);
            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(16);
            pdf.text("Patient Summary", margin, y);
            y += lineSpacing + 2;
            pdf.setDrawColor(220, 220, 220);
            pdf.line(margin, y, contentWidth + margin, y);
            y += paraSpacing;
            
            const summaryPoints = [
                {label: "Age:", value: `${age}`},
                {label: "Current eGFR:", value: `${egfr.toFixed(0)} mL/min/1.73m²`},
                {label: "CKD Stage:", value: `${ckdInfo.stage} (${ckdInfo.description})`},
                {label: "Annual Decline:", value: hasSufficientDataForDecline ? `${annualDecline.toFixed(1)} mL/min/year` : 'N/A (insufficient data)'}
            ];
            
            pdf.setFontSize(12);
            summaryPoints.forEach(point => {
                checkPageBreak(lineSpacing * lineHeightFactor);
                pdf.setFont("helvetica", "bold");
                pdf.text(point.label, margin, y);
                pdf.setFont("helvetica", "normal");
                pdf.text(point.value, margin + 45, y);
                y += lineSpacing * lineHeightFactor;
            });
            y += paraSpacing;

            // --- eGFR Trend Chart ---
            checkPageBreak(85);
            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(16);
            pdf.text("eGFR Trend", margin, y);
            y += lineSpacing;
            const chartHeight = 70;
            pdf.addImage(chartImage, 'PNG', margin, y, contentWidth, chartHeight);
            y += chartHeight + paraSpacing;
            
            // --- Tolvaptan Alert ---
            const tolvaptanRec = ALL_RECOMMENDATIONS.find(r => r.title === 'Tolvaptan Therapy');
            const meetsCriteria = tolvaptanRec.condition(patientData);
            let alertText = '';
            let alertBgColor = '#F0F9FF'; // Default blue
            let alertBorderColor = '#BAE6FD'; // sky-200
            
            if (!hasSufficientDataForDecline) {
                alertText = 'Cannot determine eligibility for Tolvaptan. An eGFR decline rate requires at least two measurements spaced over 6 months apart.';
                alertBgColor = '#FEFCE8'; // yellow-50
                alertBorderColor = '#FEF08A'; // yellow-200
            } else if (meetsCriteria) {
                alertText = `Based on your age, eGFR of ${egfr.toFixed(0)}, and annual decline of ${patientData.annualDecline.toFixed(1)}, you meet the criteria for consideration of Tolvaptan therapy. Discuss risks and benefits with your nephrologist.`;
                 alertBgColor = '#F0FDF4'; // green-50
                 alertBorderColor = '#BBF7D0'; // green-200
            } else {
                 alertText = 'You do not currently meet the primary criteria for Tolvaptan therapy.';
            }

            const splitAlert = pdf.splitTextToSize(alertText, contentWidth - 10);
            const alertHeight = (splitAlert.length * lineSpacing * lineHeightFactor) + 20;
            checkPageBreak(alertHeight);
            
            pdf.setFillColor(alertBgColor);
            pdf.setDrawColor(alertBorderColor);
            pdf.roundedRect(margin, y, contentWidth, alertHeight - paraSpacing, 3, 3, 'FD');

            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(14);
            pdf.text("Tolvaptan Therapy Alert", margin + 5, y + 8);
            pdf.setFont("helvetica", "normal");
            pdf.setFontSize(12);
            pdf.text(splitAlert, margin + 5, y + 16, { lineHeightFactor: lineHeightFactor });
            y += alertHeight;

            // --- RECOMMENDATIONS ---
            checkPageBreak(20);
            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(18);
            pdf.text("Your Personalized Recommendations", margin, y);
            y += paraSpacing;
            
            const recommendations = getFilteredRecommendations(patientData);
            const groupedRecs = recommendations.reduce((acc, rec) => {
                (acc[rec.category] = acc[rec.category] || []).push(rec);
                return acc;
            }, {});

            for(const category in groupedRecs) {
                const recs = groupedRecs[category];
                const styles = CATEGORY_STYLES[category];

                // --- 1. Calculate height for the block ---
                let blockHeight = lineSpacing * 1.5; // Top padding
                blockHeight += lineSpacing; // Category Title
                blockHeight += paraSpacing / 2;
                
                recs.forEach(rec => {
                     blockHeight += lineSpacing * 1.2; // Rec title height + padding
                     const points = rec.points.map(p => `• ${p}`);
                     const textBlock = pdf.splitTextToSize(points.join('\n'), contentWidth - 20);
                     blockHeight += textBlock.length * lineSpacing * lineHeightFactor; // Height of points
                     blockHeight += paraSpacing / 2; // Padding after points
                });
                
                // --- 2. Check for page break and draw container ---
                checkPageBreak(blockHeight);
                const startY = y;
                pdf.setFillColor(styles.hex);
                pdf.roundedRect(margin, y, contentWidth, blockHeight, 3, 3, 'F');
                y += paraSpacing;

                // --- 3. Draw content ---
                pdf.setFont("helvetica", "bold");
                pdf.setFontSize(16);
                pdf.text(category, margin + 5, y);
                y += lineSpacing + 2;
                
                recs.forEach(rec => {
                    pdf.setFont("helvetica", "bold");
                    pdf.setFontSize(14);
                    pdf.text(rec.title, margin + 5, y);
                    y += lineSpacing;

                    pdf.setFont("helvetica", "normal");
                    pdf.setFontSize(12);
                    const points = rec.points.map(p => `• ${p}`);
                    const textBlock = pdf.splitTextToSize(points.join('\n'), contentWidth - 20);
                    pdf.text(textBlock, margin + 10, y, { lineHeightFactor: lineHeightFactor });
                    y += (textBlock.length * lineSpacing * lineHeightFactor) + (paraSpacing / 2);
                });

                y = startY + blockHeight + paraSpacing; // Move y to below the completed block
            }
            
            addFooter(pdf.internal.getNumberOfPages());
            pdf.save(`${name}_ADPKD_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        }
        
        // --- Helper to get recommendations for both UI and PDF ---
        function getFilteredRecommendations(data) {
            let recommendations = ALL_RECOMMENDATIONS.filter(rec => {
                const stage = data.ckdStage;
                const minStageOk = !rec.minStage || stage >= rec.minStage;
                const maxStageOk = !rec.maxStage || stage <= rec.maxStage;
                const sexOk = !rec.sex || rec.sex === data.sex;
                const conditionOk = !rec.condition || rec.condition(data);
                return minStageOk && maxStageOk && sexOk && conditionOk;
            });
             recommendations.forEach(rec => {
                if (rec.isDynamic) {
                    if (rec.title === 'Diet and Nutrition') {
                        const protein = isNaN(data.weight) ? "0.8-1.0 g/kg/day" : `~${(0.8*data.weight).toFixed(0)}-${(1.0*data.weight).toFixed(0)} g/day`;
                        rec.points = [`Water intake: Aim for >2-3 liters/day, especially if on Tolvaptan.`, `Salt intake: Limit to <5 g/day (<2g sodium).`, `Protein intake: ${protein}.`];
                    }
                    if (rec.title === 'Blood Pressure Management') {
                        let target = '<130/80 mm Hg';
                        if (data.age >= 18 && data.age <= 50 && data.ckdStage <= 1) {
                            target = '≤110/75 mm Hg';
                        }
                        rec.points = [`For your profile, a target BP of ${target} is suggested.`, 'ACE inhibitors or ARBs are the recommended first-line treatment.'];
                    }
                }
            });
            return recommendations;
        }

        // --- RECOMMENDATION RENDERING (for UI only) ---
        function generateAndDisplayRecommendations(data, areaId, filterId) {
            const recommendations = getFilteredRecommendations(data);
            const container = document.getElementById(areaId);
            container.innerHTML = '';
            
            recommendations.forEach(rec => {
                 const styles = CATEGORY_STYLES[rec.category] || { color: 'slate', icon: 'info' };
                 const card = document.createElement('div');
                 card.className = `recommendation-card border-l-4 p-4 bg-${styles.hex} border-${styles.border} rounded-r-lg shadow-sm`;
                 card.setAttribute('data-category', rec.category);
                 
                 let pointsHTML = `<ul class="mt-3 ml-1 space-y-2 text-slate-700 list-disc list-inside">${rec.points.map(p => `<li>${p}</li>`).join('')}</ul>`;
                 if (rec.subPoints) {
                     pointsHTML += `<div class="mt-3 ml-1 text-xs text-slate-600">${rec.subPoints.join('<br>')}</div>`;
                 }

                 card.innerHTML = `
                     <div class="flex justify-between items-start">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i data-lucide="${rec.icon || styles.icon}" style="color:${styles.border}"></i>${rec.title}</h3>
                        <span class="text-xs font-semibold uppercase text-slate-600 bg-slate-200 px-2 py-1 rounded-full">${rec.category}</span>
                     </div>
                     ${pointsHTML}`;
                 container.appendChild(card);
            });
            lucide.createIcons();

            if (filterId) { 
                const filterContainer = document.getElementById(filterId);
                const categories = ['All', ...new Set(recommendations.map(r => r.category))];
                filterContainer.innerHTML = '';
                categories.forEach(cat => {
                    const styles = CATEGORY_STYLES[cat] || { color: 'slate' };
                    const btn = document.createElement('button');
                    btn.className = 'filter-button text-sm font-semibold px-4 py-2 rounded-full transition-colors focus-ring';
                    btn.dataset.category = cat;
                    if(cat === 'All') {
                        btn.className += ' active bg-blue-600 text-white';
                    } else {
                         btn.className += ` text-slate-700 bg-white hover:bg-slate-100 border border-slate-300`;
                    }
                    btn.textContent = cat;
                    btn.onclick = () => filterRecommendations(cat);
                    filterContainer.appendChild(btn);
                });
                filterRecommendations('All');
            }
        }
        function filterRecommendations(category) {
            document.querySelectorAll('#recommendationFilters .filter-button').forEach(btn => {
                const btnCat = btn.dataset.category;
                const isActive = btnCat === category;
                
                btn.classList.toggle('active', isActive);
                if(btnCat === 'All') {
                    btn.classList.toggle('bg-blue-600', isActive);
                    btn.classList.toggle('text-white', isActive);
                } else {
                    const styles = CATEGORY_STYLES[btnCat] || { color: 'slate' };
                    btn.classList.toggle(`bg-${styles.hex.replace('#', '')}`, isActive); // a bit hacky for color
                    btn.classList.toggle(`border-transparent`, isActive);
                }
            });

            document.querySelectorAll('#recommendationsArea .recommendation-card').forEach(card => {
                card.style.display = (category === 'All' || card.getAttribute('data-category') === category) ? 'block' : 'none';
            });
        }

    </script>
</body>
</html>

