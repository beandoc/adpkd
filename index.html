<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADPKD Risk Assessment & Road Map</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Modern CSS Reset --- */
        *, *::before, *::after { box-sizing: border-box; }
        body, h1, h2, h3, p, ul, li { margin: 0; }
        ul { padding: 0; list-style: none; }
        button, input, select { font: inherit; }

        /* --- CSS Variables for a Professional Theme --- */
        :root {
            --blue-primary: #3b82f6;
            --blue-dark: #2563eb;
            --grey-background: #f3f4f6;
            --card-background: #ffffff;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            
            /* Category & Semantic Colors */
            --green: #10b981; --green-bg: #f0fdf4; /* Lifestyle */
            --teal: #14b8a6; --teal-bg: #f0fdfa; /* Medical */
            --yellow: #f59e0b; --yellow-bg: #fffbeb; /* Monitoring */
            --pink: #ec4899; --pink-bg: #fdf2f8; /* Pregnancy */
            --orange: #f97316; --orange-bg: #fff7ed; /* Complications */
            --indigo: #6366f1; --indigo-bg: #eef2ff; /* Neurological */
            --red: #ef4444; --red-bg: #fef2f2; /* Future/High Risk */
        }

        /* --- General Body & Layout --- */
        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--grey-background);
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .hero-header {
            background-color: var(--blue-primary);
            color: white;
            padding: 2.5rem 1rem;
            text-align: center;
        }
        .hero-header h1 { font-size: 2.25rem; font-weight: 700; }
        .hero-header p { font-size: 1.125rem; opacity: 0.9; margin-top: 0.5rem; }

        .main-container {
            max-width: 950px;
            margin: -2rem auto 2rem auto;
            padding: 0 1rem;
            position: relative;
            z-index: 10;
        }
        
        .card {
            background-color: var(--card-background);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 1.5rem 2rem;
            margin-bottom: 1.5rem;
        }
        .card h2 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; }

        /* --- Form Styling --- */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        .input-group label, .radio-group-label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-dark); }
        .input-group input, .input-group select {
            width: 100%;
            padding: 0.65rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: var(--blue-primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        
        .radio-group { display: flex; gap: 1rem; }
        .radio-group label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .radio-group input[type="radio"] {
            -webkit-appearance: none;
            appearance: none;
            width: 1.25em; height: 1.25em;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            transition: 0.2s all linear;
        }
        .radio-group input[type="radio"]:checked { border: 5px solid var(--blue-primary); }

        .action-button {
            background-color: var(--blue-primary);
            color: white;
            font-weight: 600; padding: 0.75rem 1.5rem;
            border: none; border-radius: var(--radius-md);
            cursor: pointer; transition: background-color 0.2s;
        }
        .action-button:hover { background-color: var(--blue-dark); }
        .secondary-button { background-color: transparent; color: var(--blue-primary); font-weight: 600; cursor:pointer; border:none; padding: 0.5rem; }
        
        /* --- Previous Creatinine Entries --- */
        #previousCreatinineList .entry { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Adjusted for date input */
            gap: 1rem; 
            align-items: end; 
            padding: 1rem 0; 
            border-bottom: 1px solid var(--border-color); 
        }
        #previousCreatinineList .entry:first-child { border-top: 1px solid var(--border-color); }
        .delete-btn { 
            background: var(--red-bg); 
            color: var(--red); 
            border:none; 
            border-radius:var(--radius-md); 
            width: 44px; 
            height: 44px; 
            cursor:pointer; 
            font-size: 1.2rem;
            display: flex; /* For centering the icon */
            justify-content: center;
            align-items: center;
        }

        /* --- Results Section --- */
        .results-grid { 
            display: grid;
            grid-template-columns: 1fr 1.5fr; /* Adjusted to fit graph */
            gap: 2rem; 
            align-items: center; 
        }
        .egfr-display h3 { color: var(--text-light); font-weight: 500; }
        .egfr-display .value { font-size: 2.5rem; font-weight: 700; color: var(--blue-primary); }
        .ckd-stages-container { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;}
        .ckd-stage-pill { padding: 0.3rem 0.8rem; border-radius: 99px; font-weight: 500; border: 1px solid var(--border-color); }
        .ckd-stage-pill.g1 { background-color: var(--green-bg); border-color: var(--green); color: var(--green); }
        .ckd-stage-pill.g2 { background-color: var(--green-bg); border-color: var(--green); color: var(--green); }
        .ckd-stage-pill.g3a { background-color: var(--yellow-bg); border-color: var(--yellow); color: var(--yellow); }
        .ckd-stage-pill.g3b { background-color: var(--yellow-bg); border-color: var(--yellow); color: var(--yellow); }
        .ckd-stage-pill.g4 { background-color: var(--red-bg); border-color: var(--red); color: var(--red); }
        .ckd-stage-pill.g5 { background-color: var(--red-bg); border-color: var(--red); color: var(--red); }
        .ckd-stage-pill.active { transform: scale(1.05); box-shadow: 0 0 10px rgba(0,0,0,0.1);}
        
        /* eGFR Trend Chart */
        .egfr-trend-chart-container {
            position: relative;
            height: 200px; /* Adjust height as needed */
            width: 100%;
        }

        /* Explore Future Scenarios Slider */
        .future-scenario-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .egfr-slider-container {
            width: 100%;
            margin-top: 1rem;
            position: relative;
            padding-bottom: 1.5rem; /* Space for labels */
        }
        
        .egfr-slider-container input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 12px;
            border-radius: 8px;
            background: linear-gradient(to right, 
                var(--green) 0%, var(--green) 40%, /* G1-G2 */
                var(--yellow) 40%, var(--yellow) 70%, /* G3a-G3b */
                var(--orange) 70%, var(--orange) 85%, /* G4 */
                var(--red) 85%, var(--red) 100% /* G5 */
            );
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
            margin: 0;
            cursor: pointer;
        }

        .egfr-slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--blue-primary);
            cursor: pointer;
            border: 2px solid var(--card-background);
            box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
            margin-top: -6px; /* Center thumb vertically */
        }

        .egfr-slider-container input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--blue-primary);
            cursor: pointer;
            border: 2px solid var(--card-background);
            box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-light);
            position: absolute;
            width: 100%;
            top: calc(100% - 1.2rem); /* Position below the track */
            left: 0;
            pointer-events: none; /* Make labels unclickable */
        }
        .slider-labels span {
            font-weight: 500;
        }
        .slider-labels .normal { color: var(--green); }
        .slider-labels .moderate { color: var(--yellow); }
        .slider-labels .failure { color: var(--red); }

        .projected-egfr-display {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 1.125rem;
            font-weight: 600;
        }
        .projected-egfr-display .value {
            color: var(--blue-primary);
            font-size: 1.5rem;
        }

        /* --- PROPKD Score Section --- */
        .propkd-results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1.5rem; }
        .propkd-breakdown div { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed var(--border-color); }
        .propkd-breakdown span:last-child { font-weight: 600; }
        .propkd-breakdown .total { font-weight: 700; color: var(--blue-primary); font-size: 1.2rem; }
        .propkd-risk-profile { background-color: var(--grey-background); padding: 1rem; border-radius: var(--radius-md); }
        .propkd-risk-profile .risk-level-tag { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 99px; font-weight: 600; margin-bottom: 0.5rem; }
        .propkd-risk-profile .risk-level-tag.low { background-color: var(--green-bg); color: var(--green); }
        .propkd-risk-profile .risk-level-tag.intermediate { background-color: var(--yellow-bg); color: var(--yellow); }
        .propkd-risk-profile .risk-level-tag.high { background-color: var(--red-bg); color: var(--red); }

        /* --- Recommendations Section --- */
        .filter-buttons { display: flex; flex-wrap:wrap; gap: 0.5rem; margin-bottom: 1.5rem; }
        .filter-button { background-color: var(--grey-background); color: var(--text-light); border: none; padding: 0.5rem 1rem; border-radius: 99px; cursor: pointer; font-weight: 500; }
        .filter-button.active { background-color: var(--blue-primary); color: white; }
        
        .recommendation-card {
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            border-left: 5px solid;
            position: relative;
        }
        .recommendation-card h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; }
        .recommendation-card ul { padding-left: 1.2rem; list-style-type: disc; }
        .recommendation-card li { margin-bottom: 0.3rem; }
        .recommendation-card::after { /* Category Tag */
            content: attr(data-category);
            position: absolute; top: 1rem; right: 1rem;
            font-size: 0.75rem; font-weight: 500;
            padding: 0.2rem 0.6rem;
            border-radius: 99px;
            color: white;
        }
        /* Card Colors */
        .recommendation-card.lifestyle { border-color: var(--green); background-color: var(--green-bg); }
        .recommendation-card.lifestyle::after { background-color: var(--green); }
        .recommendation-card.medical { border-color: var(--teal); background-color: var(--teal-bg); }
        .recommendation-card.medical::after { background-color: var(--teal); }
        .recommendation-card.monitoring { border-color: var(--yellow); background-color: var(--yellow-bg); }
        .recommendation-card.monitoring::after { background-color: var(--yellow); }
        .recommendation-card.pregnancy { border-color: var(--pink); background-color: var(--pink-bg); }
        .recommendation-card.pregnancy::after { background-color: var(--pink); }
        .recommendation-card.complications { border-color: var(--orange); background-color: var(--orange-bg); }
        .recommendation-card.complications::after { background-color: var(--orange); }
        .recommendation-card.neurological { border-color: var(--indigo); background-color: var(--indigo-bg); }
        .recommendation-card.neurological::after { background-color: var(--indigo); }
        .recommendation-card.future { border-color: var(--red); background-color: var(--red-bg); }
        .recommendation-card.future::after { background-color: var(--red); }
        
        /* --- Disclaimer --- */
        .disclaimer { text-align: center; color: var(--text-light); font-size: 0.875rem; padding: 0 1rem; }

        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            .results-grid, .propkd-results-grid { grid-template-columns: 1fr; }
            .card { padding: 1.5rem; }
            #previousCreatinineList .entry { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header class="hero-header">
        <h1>Your ADPKD Risk Assessment & Road Map</h1>
        <p>Your personalized kidney health journey</p>
    </header>

    <main class="main-container">
        <section class="card">
            <h2>Enter Your Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label for="patientName">Patient Name</label>
                    <input type="text" id="patientName" placeholder="e.g., John Doe">
                </div>
                <div class="input-group">
                    <label for="age">Age (years)</label>
                    <input type="number" id="age" min="1" placeholder="e.g., 42">
                </div>
                <div class="input-group">
                    <label class="radio-group-label">Sex</label>
                    <div class="radio-group">
                        <label><input type="radio" name="sex" value="male" checked> Male</label>
                        <label><input type="radio" name="sex" value="female"> Female</label>
                    </div>
                </div>
                <div class="input-group">
                     <label for="weight">Weight (kg)</label>
                     <input type="number" id="weight" name="weight" min="1" placeholder="e.g., 75">
                </div>
            </div>
        </section>

        <section class="card">
            <h2>Enter Your Creatinine Values</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label for="currentCreatinine">Current Creatinine (mg/dL)</label>
                    <input type="number" id="currentCreatinine" step="0.01" min="0.1" placeholder="e.g., 1.5">
                </div>
                <div class="input-group">
                    <label for="currentCreatinineDate">Date of Measurement</label>
                    <input type="date" id="currentCreatinineDate">
                </div>
            </div>
            
            <h3 style="margin-top: 1.5rem; font-weight:600;">Previous Creatinine Values</h3>
            <div id="previousCreatinineList"></div>
            <button type="button" class="secondary-button" onclick="addPreviousCreatinineEntry()">+ Add Previous Measurement</button>
            <br>
            <button type="button" class="action-button" onclick="calculateAndDisplay()">Calculate Kidney Health</button>
        </section>

        <section class="card" id="resultsCard" style="display: none;">
            <h2>Your eGFR Results</h2>
            <div class="results-grid">
                <div class="egfr-display">
                    <h3>Current eGFR</h3>
                    <p class="value" id="currentEgfrResult">-</p>
                    <h3>CKD Stage</h3>
                    <div id="ckdStagesContainer" class="ckd-stages-container">
                        </div>
                    <h3>Annual eGFR Decline</h3>
                    <p class="value" id="annualEgfrDeclineResult" style="font-size: 1.8rem;">-</p>
                    <p id="rapidProgressorAlert" style="color:var(--red); font-weight:600;"></p>
                </div>
                <div class="egfr-trend-chart-container">
                    <canvas id="egfrTrendChart"></canvas>
                </div>
            </div>

            <div class="future-scenario-section">
                <h3>Explore Future Scenarios</h3>
                <p style="color: var(--text-light); margin-bottom: 1rem;">Move the slider to see recommendations for different eGFR levels</p>
                <div class="egfr-slider-container">
                    <input type="range" id="egfrScenarioSlider" min="10" max="120" step="1" value="90" oninput="updateProjectedEgfrAndRecommendations()">
                    <div class="slider-labels">
                        <span class="normal">Normal</span>
                        <span class="moderate">Moderate CKD</span>
                        <span class="failure">Kidney Failure</span>
                    </div>
                </div>
                <p class="projected-egfr-display">Projected eGFR: <span class="value" id="projectedEgfrDisplay">-</span> (<span id="projectedCkdStageDisplay">CKD Stage: -</span>)</p>
            </div>
        </section>
        
        <section class="card">
            <h2>PROPKD Risk Score Calculator</h2>
            <p style="margin-top:-1rem; margin-bottom:1.5rem; color: var(--text-light);">This score helps predict the risk of End-Stage Renal Disease (ESRD) for patients with PKD1/PKD2 mutations.</p>
            <div class="form-grid">
                 <div class="input-group">
                    <label for="hypertensionBefore35">Hypertension before age 35?</label>
                    <select id="hypertensionBefore35">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="urologicEventBefore35">First urologic event before age 35?*</label>
                    <select id="urologicEventBefore35">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                 <div class="input-group">
                    <label for="mutationType">Genetic Mutation Type (if known)</label>
                    <select id="mutationType">
                        <option value="unknown">Unknown / Not tested</option>
                        <option value="pkd2">PKD2 mutation</option>
                        <option value="nontrunc_pkd1">Nontruncating PKD1 mutation</option>
                        <option value="trunc_pkd1">Truncating PKD1 mutation</option>
                    </select>
                </div>
            </div>
             <small style="display:block; margin-top: 0.5rem; color: var(--text-light);">*Urologic event: kidney infection, flank pain, hematuria, cyst hemorrhage, or kidney stone.</small>

            <button type="button" class="action-button" onclick="calculateAndDisplayPROPKD()" style="margin-top:1.5rem;">Calculate PROPKD Score</button>
            
            <div id="propkdResultsArea" style="display:none;">
                <div class="propkd-results-grid">
                    <div class="propkd-breakdown">
                        <h3>Score Calculation</h3>
                        <div id="propkd_male"><span>Sex (Male)</span><span>-</span></div>
                        <div id="propkd_htn"><span>Hypertension < 35y</span><span>-</span></div>
                        <div id="propkd_event"><span>Urologic Event < 35y</span><span>-</span></div>
                        <div id="propkd_mutation"><span>Mutation Type</span><span>-</span></div>
                        <div><span class="total">TOTAL SCORE</span><span class="total" id="propkdScoreResult">-</span></div>
                    </div>
                    <div class="propkd-risk-profile">
                        <h3>Your Risk Profile</h3>
                        <p><span id="propkdRiskLevelTag" class="risk-level-tag">-</span></p>
                        <p id="propkdRiskProfileResult" style="color: var(--text-light)"></p>
                    </div>
                </div>
            </div>
        </section>

        <section class="card" id="recommendationsCard" style="display: none;">
            <h2>Personalized Recommendations</h2>
             <div class="filter-buttons" id="recommendationFilters">
                </div>
            <div id="recommendationsArea">
            </div>
        </section>
        
        <p class="disclaimer"><strong>Disclaimer:</strong> Recommendations are based on current KDIGO (Kidney Disease: Improving Global Outcomes) guidelines for ADPKD and other cited research.  This tool is for educational and informational purposes only and does not constitute medical advice.  Always consult with qualified healthcare professionals for medical decisions and patient-specific management, as they can consider your individual medical history and circumstances.  The PROPKD score is a predictive tool, and actual outcomes can vary. </p>

    </main>

    <script>
        // --- CONFIG & SETUP ---
        const CURRENT_YEAR = new Date().getFullYear(); [cite: 317]
        const CURRENT_MONTH = new Date().getMonth(); // 0-indexed 
        const MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]; [cite: 318]
        let creatinineEntryCounter = 0; [cite: 318]
        let egfrTrendChartInstance = null; // To store the Chart.js instance

        // --- RECOMMENDATION DATABASE ---
        const ALL_RECOMMENDATIONS = [
            // Lifestyle
            { category: 'Lifestyle', title: 'Physical Activity', points: ['Undertake moderate-intensity physical activity for at least 150 minutes per week.', 'Adjust activity level based on cardiovascular and physical tolerance.', 'Consider activities like walking, swimming, or cycling that are gentle on joints.', 'Consult with healthcare provider before starting new exercise regimen.'] },
            { category: 'Lifestyle', title: 'Diet and Nutrition', isDynamic: true, points: [] }, // Points are generated dynamically 
            { category: 'Lifestyle', title: 'Tobacco Use', points: ['Avoid smoking - strong risk factor for intracranial aneurysm (ICA) development and rupture.', 'Seek support for smoking cessation if needed.', 'Avoid secondhand smoke exposure.'] },

            // Neurological
            { category: 'Neurological', title: 'Neurological Awareness', points: ['Recognize "thunderclap headache" (severe sudden-onset headache reaching maximum intensity within seconds to a minute).', 'Seek immediate medical attention if a thunderclap headache occurs.', 'Be aware of other neurological symptoms: confusion, neck stiffness, sensitivity to light.', 'Report any unusual neurological symptoms to your healthcare provider promptly.'] }, [cite: 320]

            // Monitoring
            { category: 'Monitoring', title: 'Aneurysm Screening', points: ['Screening for intracranial aneurysms (ICA) is recommended if you have a personal history of subarachnoid hemorrhage (SAH), a family history of ICA or SAH, or a family history of unexplained sudden death.', 'Screening for aortic aneurysms may be considered if there is a family history of aortic root or thoracic aortic aneurysms.'] }, [cite: 321]
            { category: 'Monitoring', title: 'Living Donor Considerations', points: ['It is important to exclude the diagnosis of ADPKD in potential living-related kidney donors.', 'Family members should be appropriately screened before donation.', 'Genetic counseling may be recommended.'] },
            { category: 'Monitoring', title: 'Advanced CKD Management', minStage: 4, points: ['Referral to nephrology if not already under specialist care.', 'Monitoring for metabolic bone disease.', 'Dietary phosphorus restriction may be necessary.', 'Regular monitoring for anemia and appropriate management.'] }, [cite: 322]
            
            // Medical
            { category: 'Medical', title: 'Blood Pressure Management', points: ['Target blood pressure: <120/80 mm Hg.', 'Regular home blood pressure monitoring is recommended.', 'Consider ACE inhibitors or ARBs as first-line therapy.', 'Lifestyle modifications like reduced salt intake, regular exercise, and stress management are crucial.'] }, [cite: 323]
            { category: 'Medical', title: 'Tolvaptan Therapy', condition: (data) => data.age >= 18 && data.age <= 55 && data.egfr >= 25, points: ['Consider Tolvaptan therapy for slowing kidney function decline, especially if there is evidence of rapid progression.', 'Regular liver function monitoring is required while on therapy.', 'Ensure adequate hydration to manage increased thirst.', 'Must be discontinued before pregnancy and during breastfeeding. Discuss all benefits and risks with your nephrologist.'] }, [cite: 324]
            { category: 'Medical', title: 'Anemia Management', minStage: 3.1, points: ['Regular monitoring for anemia is needed in CKD Stage 3 and beyond.', 'Hypoxia-inducible factor-prolyl hydroxylase inhibitors (HIF-PHIs) should NOT be used to manage anemia in people with ADPKD who are not receiving dialysis.', 'Iron supplementation may be recommended if deficient.'] },
            { category: 'Medical', title: 'Diabetes Management', minStage: 3.1, points: ['Management of diabetes should follow standard CKD guidelines.', 'Sodium-glucose cotransporter-2 inhibitors (SGLT2i) are NOT recommended at this time for people with ADPKD.', 'Regular monitoring of blood glucose levels is essential.'] }, [cite: 325]
            { category: 'Medical', title: 'CKD Stage 3-5 Management', minStage: 3.1, points: ['Regular monitoring of electrolytes, calcium, and phosphorus.', 'Consider vitamin D supplementation if deficient.', 'Avoid nephrotoxic medications including NSAIDs.', 'Manage anemia and diabetes according to specific ADPKD guidelines (see other cards).'] },

            // Complications
            { category: 'Complications', title: 'Kidney Stone Management', points: ['Discuss any history of kidney stones with your doctor.', 'Aim for a daily urine output of 2.5 liters by increasing fluid intake, especially water.', 'Dietary modifications may be considered if you have a history of stones.', 'Seek prompt medical attention for symptoms of kidney stones (e.g., severe flank pain, blood in urine).'] }, [cite: 326]
            { category: 'Complications', title: 'Polycystic Liver Disease (PLD)', points: ['Be aware that estrogen exposure (e.g., from contraceptives or hormone therapy) may increase the risk of PLD progression.', 'Discuss hormone replacement therapy risks with your doctor.', 'Report symptoms like abdominal pain, fullness, or feeling full early during meals.'] }, [cite: 327]

            // Pregnancy
            { category: 'Pregnancy', title: 'Contraception & PLD', points: ['Discuss contraceptive choices with your doctor, as estrogen and possibly progesterone exposure may be associated with an increased risk of Polycystic Liver Disease (PLD) progression.'] },
            { category: 'Pregnancy', title: 'Pregnancy Planning', points: ['If planning pregnancy, use of tolvaptan and other potentially harmful drugs should be stopped prior to conception and not restarted until breastfeeding is completed.  Discuss all medications with your doctor.'] }, [cite: 329]
            { category: 'Pregnancy', title: 'Pregnancy & Aspirin', points: ['For pregnant women with ADPKD, low-dose aspirin (75–150 mg daily) may be prescribed by your doctor from week 12 to week 36 to reduce the risk of pre-eclampsia.'] }
        ]; [cite: 330]

        // --- DOMContentLoaded: Initial page setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set current creatinine date to today by default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('currentCreatinineDate').value = today;
            // No need to populate dropdowns for input type="date"
        });

        // function populateDateDropdowns(monthId, yearId, isCurrent) is no longer needed

        // --- DYNAMICALLY ADD/REMOVE CREATININE ENTRIES ---
        function addPreviousCreatinineEntry() {
            creatinineEntryCounter++; [cite: 336]
            const list = document.getElementById('previousCreatinineList');
            const entry = document.createElement('div');
            entry.className = 'entry';
            entry.id = `entry-${creatinineEntryCounter}`;
            entry.innerHTML = `
                <div class="input-group"><label for="prev_creat_val_${creatinineEntryCounter}">Creatinine (mg/dL)</label><input type="number" class="prev_creat_val" id="prev_creat_val_${creatinineEntryCounter}" step="0.01" min="0.1" placeholder="e.g., 1.2"></div>
                <div class="input-group"><label for="prev_creat_date_${creatinineEntryCounter}">Date of Measurement</label><input type="date" class="prev_creat_date" id="prev_creat_date_${creatinineEntryCounter}"></div>
                <button type="button" class="delete-btn" onclick="removeEntry('entry-${creatinineEntryCounter}')" aria-label="Remove entry">🗑️</button>
            `; [cite: 337, 338]
            list.appendChild(entry);
            // Optionally set a default date for new entries, e.g., one year ago
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            entry.querySelector(`.prev_creat_date`).value = oneYearAgo.toISOString().split('T')[0];
        }

        function removeEntry(id) { document.getElementById(id)?.remove(); } [cite: 339]

        // --- CORE CALCULATIONS ---
        function calculateEGFR(creatinine, age, sex) {
            if (isNaN(creatinine) || creatinine <= 0 || isNaN(age) || age <= 0) return NaN; [cite: 340]
            const kappa = (sex === 'female') ? 0.7 : 0.9; [cite: 340]
            const alpha = (sex === 'female') ? -0.241 : -0.302; [cite: 341]
            const sexFactor = (sex === 'female') ? 1.012 : 1.0; [cite: 342]
            return 142 * Math.min(creatinine / kappa, 1) ** alpha * Math.max(creatinine / kappa, 1) ** (-1.200) * (0.9938 ** age) * sexFactor; [cite: 343]
        }

        function getCKDStage(egfr) {
            if (isNaN(egfr)) return { stage: 'N/A', num: 0 }; [cite: 344]
            if (egfr >= 90) return { stage: 'G1', num: 1 }; [cite: 345]
            if (egfr >= 60) return { stage: 'G2', num: 2 }; [cite: 346]
            if (egfr >= 45) return { stage: 'G3a', num: 3.1 }; [cite: 347]
            if (egfr >= 30) return { stage: 'G3b', num: 3.2 }; [cite: 348]
            if (egfr >= 15) return { stage: 'G4', num: 4 }; [cite: 348]
            return { stage: 'G5', num: 5 }; [cite: 349]
        }
        
        function ageAtDate(currentAge, dateOfCurrentAge, pastDate) {
            return Math.max(0, currentAge - (dateOfCurrentAge - pastDate) / (31557600000)); [cite: 350]
        }

        // --- CHART.JS RENDERING ---
        function renderEgfrTrendChart(dataPoints) {
            const ctx = document.getElementById('egfrTrendChart').getContext('2d');
            if (egfrTrendChartInstance) {
                egfrTrendChartInstance.destroy(); // Destroy previous instance if it exists
            }

            // Get CSS variables using getComputedStyle BEFORE chart creation
            const style = getComputedStyle(document.body);
            const var_blue_primary = style.getPropertyValue('--blue-primary').trim();

            const labels = dataPoints.map(p => p.date.toLocaleDateString('en-US', { month: '2-digit', year: 'numeric' }));
            const egfrData = dataPoints.map(p => p.egfr.toFixed(1));

            egfrTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'eGFR',
                        data: egfrData,
                        borderColor: var_blue_primary, 
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        tension: 0.1,
                        fill: false,
                        pointRadius: 5,
                        pointBackgroundColor: var_blue_primary
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'category', 
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'eGFR (mL/min/1.73m²)'
                            },
                            min: 0,
                            max: 90, 
                            ticks: {
                                stepSize: 5
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false 
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `eGFR: ${context.raw} mL/min/1.73m²`;
                                }
                            }
                        }
                    }
                }
            });
            // No need to update colors again here, they are set during creation.
        }

        // --- MAIN CALCULATION & DISPLAY LOGIC ---
        function calculateAndDisplay() {
            const age = parseFloat(document.getElementById('age').value); [cite: 351]
            const sex = document.querySelector('input[name="sex"]:checked').value; [cite: 351]
            const currentCreatinine = parseFloat(document.getElementById('currentCreatinine').value); [cite: 294]
            const currentCreatinineDateStr = document.getElementById('currentCreatinineDate').value;

            if (isNaN(age) || isNaN(currentCreatinine) || !currentCreatinineDateStr) {
                alert('Please fill in Age, Current Creatinine, and Date of Measurement.'); [cite: 353]
                return;
            }
            document.getElementById('resultsCard').style.display = 'block'; [cite: 354]
            document.getElementById('recommendationsCard').style.display = 'block'; [cite: 354]

            const currentDate = new Date(currentCreatinineDateStr);
            const currentEgfr = calculateEGFR(currentCreatinine, age, sex);
            
            document.getElementById('currentEgfrResult').textContent = `${currentEgfr.toFixed(1)} mL/min/1.73m²`;
            const currentCkdInfo = getCKDStage(currentEgfr); [cite: 355]
            renderCKDStages(currentCkdInfo.stage);

            const allPoints = [{ egfr: currentEgfr, date: currentDate }]; [cite: 356]
            document.querySelectorAll('#previousCreatinineList .entry').forEach(entry => {
                const val = parseFloat(entry.querySelector('.prev_creat_val').value);
                const dateStr = entry.querySelector('.prev_creat_date').value;
                
                if (!isNaN(val) && dateStr) {
                    const pastDate = new Date(dateStr); [cite: 357]
                    allPoints.push({ egfr: calculateEGFR(val, ageAtDate(age, currentDate, pastDate), sex), date: pastDate });
                }
            });
            allPoints.sort((a, b) => a.date - b.date); [cite: 358]

            // Render the trend chart
            renderEgfrTrendChart(allPoints);

            const declineResultEl = document.getElementById('annualEgfrDeclineResult'); [cite: 359]
            const alertEl = document.getElementById('rapidProgressorAlert'); [cite: 359]
            let annualDecline = NaN; [cite: 359]
            if (allPoints.length >= 2) {
                const first = allPoints[0]; [cite: 360]
                const last = allPoints[allPoints.length - 1]; [cite: 360]
                const timeDiffYears = (last.date - first.date) / (31557600000); [cite: 361]
                if (timeDiffYears > 0.25) { // Ensure at least 3 months for a meaningful trend 
                    annualDecline = (first.egfr - last.egfr) / timeDiffYears; [cite: 362]
                    declineResultEl.textContent = `${annualDecline.toFixed(1)} / year`; [cite: 362]
                    alertEl.textContent = annualDecline >= 3 ? "Potential Rapid Progressor" : ""; [cite: 363]
                    declineResultEl.style.color = annualDecline >= 3 ? "var(--red)" : "var(--blue-primary)"; [cite: 363]
                } else {
                    declineResultEl.textContent = "N/A"; [cite: 364]
                    alertEl.textContent = "Insufficient time between measurements."; [cite: 364]
                }
            } else {
                declineResultEl.textContent = "N/A"; [cite: 365]
                alertEl.textContent = "Need at least one past value for trend."; [cite: 366]
            }
            
            // Set slider to current eGFR and update projected display
            const egfrScenarioSlider = document.getElementById('egfrScenarioSlider');
            egfrScenarioSlider.value = currentEgfr;
            updateProjectedEgfrAndRecommendations(); // Call to update slider display and recommendations
        }

        function renderCKDStages(activeStage) {
            const container = document.getElementById('ckdStagesContainer'); [cite: 368]
            if (!container) {
                console.error("CKD stages container not found!");
                return;
            }
            container.innerHTML = ''; [cite: 368]
            const stages = [
                { stage: 'G1', text: 'eGFR ≥90' }, { stage: 'G2', text: 'eGFR 60-89' },
                { stage: 'G3a', text: 'eGFR 45-59' }, { stage: 'G3b', text: 'eGFR 30-44' },
                { stage: 'G4', text: 'eGFR 15-29' }, { stage: 'G5', text: 'eGFR <15' }
            ]; [cite: 369]
            stages.forEach(s => {
                const pill = document.createElement('div');
                pill.className = `ckd-stage-pill ${s.stage.toLowerCase()}`;
                // Special handling for G3a/G3b to apply yellow color consistently
                if (s.stage === activeStage) pill.classList.add('active');
                pill.innerHTML = `<strong>${s.stage}</strong>: ${s.text}`;
                container.appendChild(pill); [cite: 370, 371]
            });
        }
        
        // --- PROPKD SCORE ---
        function calculateAndDisplayPROPKD() {
            const sex = document.querySelector('input[name="sex"]:checked').value; [cite: 383]
            const htn = document.getElementById('hypertensionBefore35').value; [cite: 383]
            const event = document.getElementById('urologicEventBefore35').value; [cite: 383]
            const mutation = document.getElementById('mutationType').value; [cite: 383]
            let score = 0; [cite: 384]
            const scores = { male: 0, htn: 0, event: 0, mutation: 0 }; [cite: 385]
            if (sex === 'male') { score += 1; scores.male = 1; } [cite: 386]
            if (htn === 'yes') { score += 2; scores.htn = 2; } [cite: 387]
            if (event === 'yes') { score += 2; scores.event = 2; } [cite: 388]
            if (mutation === 'nontrunc_pkd1') { score += 2; scores.mutation = 2; } [cite: 389]
            else if (mutation === 'trunc_pkd1') { score += 4; scores.mutation = 4; } [cite: 390]
            
            document.getElementById('propkd_male').children[1].textContent = `${scores.male} points`; [cite: 391]
            document.getElementById('propkd_htn').children[1].textContent = `${scores.htn} points`; [cite: 391]
            document.getElementById('propkd_event').children[1].textContent = `${scores.event} points`; [cite: 391]
            document.getElementById('propkd_mutation').children[1].textContent = `${scores.mutation} points`; [cite: 391]
            document.getElementById('propkdScoreResult').textContent = score; [cite: 392]

            let riskProfile = '', riskClass = ''; [cite: 392]
            if (score <= 3) { riskProfile = 'Low Risk (Median age for ESRD: ~70.6 years)'; riskClass = 'low'; } [cite: 393]
            else if (score <= 6) { riskProfile = 'Intermediate Risk (Median age for ESRD: ~56.9 years)'; riskClass = 'intermediate'; } [cite: 394]
            else { riskProfile = 'High Risk (Median age for ESRD: ~49 years)'; riskClass = 'high'; } [cite: 395]
            
            const tagEl = document.getElementById('propkdRiskLevelTag'); [cite: 396]
            tagEl.textContent = riskClass.charAt(0).toUpperCase() + riskClass.slice(1) + " Risk"; [cite: 396]
            tagEl.className = `risk-level-tag ${riskClass}`; [cite: 396]
            
            let profileText = riskProfile; [cite: 397]
            if (mutation === 'unknown') profileText += ' *Provisional assessment as mutation type is unknown.*'; [cite: 397]
            document.getElementById('propkdRiskProfileResult').textContent = profileText; [cite: 397]
            document.getElementById('propkdResultsArea').style.display = 'block'; [cite: 398]
        }

        // --- DYNAMIC RECOMMENDATIONS AND SLIDER LOGIC ---
        function updateProjectedEgfrAndRecommendations() {
            const projectedEgfr = parseFloat(document.getElementById('egfrScenarioSlider').value);
            const projectedCkdInfo = getCKDStage(projectedEgfr);

            document.getElementById('projectedEgfrDisplay').textContent = `${projectedEgfr.toFixed(0)} mL/min/1.73m²`;
            document.getElementById('projectedCkdStageDisplay').textContent = `CKD Stage: ${projectedCkdInfo.stage}`;

            const age = parseFloat(document.getElementById('age').value);
            // Re-run recommendations with the projected eGFR and CKD stage
            generateAndDisplayRecommendations({ age, egfr: projectedEgfr, ckdStage: projectedCkdInfo.num });
        }

        function generateAndDisplayRecommendations(data) {
            const weight = parseFloat(document.getElementById('weight').value); [cite: 372]
            let recommendationsToDisplay = ALL_RECOMMENDATIONS.filter(rec => {
                const minStageOk = !rec.minStage || data.ckdStage >= rec.minStage; [cite: 373]
                const maxStageOk = !rec.maxStage || data.ckdStage <= rec.maxStage; [cite: 373]
                const conditionOk = !rec.condition || rec.condition(data); [cite: 373]
                return minStageOk && maxStageOk && conditionOk; [cite: 373]
            });

            // Handle dynamic content
            recommendationsToDisplay.forEach(rec => {
                if(rec.isDynamic && rec.title === 'Diet and Nutrition') {
                    const protein = isNaN(weight) ? "0.8-1.0 g/kg/day" : `~${(0.8*weight).toFixed(0)}-${(1*weight).toFixed(0)} g/day`;
                    const calories = isNaN(weight) ? "25–35 kcal/kg/day" : `~${(25*weight).toFixed(0)}-${(35*weight).toFixed(0)} kcal/day`; [cite: 374]
                    rec.points = [`Caloric intake: ${calories}.`, 'Fat intake: <30% of daily energy intake.', 'Water intake: >2 liters/day.', 'Salt intake: <5 grams/day.', `Protein intake: ${protein}.`, 'Maintain a healthy weight, as obesity may accelerate ADPKD progression.']; [cite: 375]
                }
            });

            const container = document.getElementById('recommendationsArea'); [cite: 375]
            container.innerHTML = ''; [cite: 375]
            recommendationsToDisplay.forEach(rec => {
                const card = document.createElement('div');
                card.className = `recommendation-card ${rec.category.toLowerCase()}`;
                card.setAttribute('data-category', rec.category);
                card.innerHTML = `<h3>${rec.title}</h3><ul>${rec.points.map(p => `<li>${p}</li>`).join('')}</ul>`;
                container.appendChild(card); [cite: 376]
            });
            
            const filterContainer = document.getElementById('recommendationFilters'); [cite: 377]
            // Ensure unique categories and 'All' option, then sort alphabetically
            const categories = ['All', ...new Set(recommendationsToDisplay.map(r => r.category))].sort((a, b) => {
                if (a === 'All') return -1; // 'All' comes first
                if (b === 'All') return 1;
                return a.localeCompare(b); // Alphabetical sort for others
            }); 
            filterContainer.innerHTML = ''; [cite: 378]
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'filter-button';
                if(cat === 'All') btn.classList.add('active');
                btn.textContent = cat;
                btn.onclick = () => filterRecommendations(cat);
                filterContainer.appendChild(btn); [cite: 379, 380]
            });
            filterRecommendations('All'); // Show all by default 
        }
        
        function filterRecommendations(category) {
            document.querySelectorAll('#recommendationFilters .filter-button').forEach(btn => btn.classList.toggle('active', btn.textContent === category)); [cite: 381]
            document.querySelectorAll('.recommendation-card').forEach(card => {
                card.style.display = (category === 'All' || card.getAttribute('data-category') === category) ? 'block' : 'none'; [cite: 382]
            });
        }

    </script>
</body>
</html>
